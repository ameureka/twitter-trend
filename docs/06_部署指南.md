# éƒ¨ç½²æŒ‡å—

## éƒ¨ç½²æ¦‚è¿°

Twitterè‡ªåŠ¨å‘å¸ƒç³»ç»Ÿæ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼Œä»æœ¬åœ°å¼€å‘åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæä¾›çµæ´»çš„éƒ¨ç½²é€‰é¡¹ä»¥æ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ã€‚

## éƒ¨ç½²æ¶æ„é€‰æ‹©

### 1. å•æœºéƒ¨ç½²
- **é€‚ç”¨åœºæ™¯**: ä¸ªäººä½¿ç”¨ã€å°å›¢é˜Ÿã€æµ‹è¯•ç¯å¢ƒ
- **èµ„æºè¦æ±‚**: 2GB RAM, 1 CPUæ ¸å¿ƒ, 10GBå­˜å‚¨
- **ä¼˜åŠ¿**: ç®€å•æ˜“ç”¨ã€æˆæœ¬ä½ã€ç»´æŠ¤ç®€å•
- **åŠ£åŠ¿**: å•ç‚¹æ•…éšœã€æ‰©å±•æ€§æœ‰é™

### 2. å®¹å™¨åŒ–éƒ¨ç½²
- **é€‚ç”¨åœºæ™¯**: ä¸­å°å‹å›¢é˜Ÿã€å¼€å‘æµ‹è¯•ç¯å¢ƒ
- **èµ„æºè¦æ±‚**: 4GB RAM, 2 CPUæ ¸å¿ƒ, 20GBå­˜å‚¨
- **ä¼˜åŠ¿**: ç¯å¢ƒä¸€è‡´æ€§ã€æ˜“äºæ‰©å±•ã€ç‰ˆæœ¬ç®¡ç†
- **åŠ£åŠ¿**: éœ€è¦DockerçŸ¥è¯†ã€èµ„æºå¼€é”€

### 3. äº‘ç«¯éƒ¨ç½²
- **é€‚ç”¨åœºæ™¯**: ä¼ä¸šçº§åº”ç”¨ã€é«˜å¯ç”¨éœ€æ±‚
- **èµ„æºè¦æ±‚**: æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´
- **ä¼˜åŠ¿**: é«˜å¯ç”¨ã€è‡ªåŠ¨æ‰©å±•ã€ä¸“ä¸šè¿ç»´
- **åŠ£åŠ¿**: æˆæœ¬è¾ƒé«˜ã€å¤æ‚åº¦é«˜

## Dockeréƒ¨ç½²

### 1. å¿«é€Ÿå¯åŠ¨

#### ä½¿ç”¨Docker Compose (æ¨è)

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/twitter-auto-publisher.git
cd twitter-auto-publisher

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
vim .env  # ç¼–è¾‘é…ç½®

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

#### Docker Compose é…ç½®

**docker-compose.yml**:

```yaml
version: '3.8'

services:
  twitter-publisher:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: twitter-publisher
    restart: unless-stopped
    ports:
      - "8080:8080"  # APIæœåŠ¡ç«¯å£
      - "8080:8080"  # Webç•Œé¢ç«¯å£
    environment:
      - APP_ENV=production
      - DATABASE_URL=sqlite:///data/twitter_publisher.db
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
      - ./projects:/app/projects  # é¡¹ç›®æ•°æ®ç›®å½•
    networks:
      - twitter-net
    healthcheck:
      test: ["CMD", "python", "-m", "app.cli", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # å¯é€‰: æ•°æ®åº“æœåŠ¡ (å¦‚æœä½¿ç”¨PostgreSQL)
  postgres:
    image: postgres:15-alpine
    container_name: twitter-publisher-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: twitter_publisher
      POSTGRES_USER: twitter_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - twitter-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U twitter_user -d twitter_publisher"]
      interval: 10s
      timeout: 5s
      retries: 5

  # å¯é€‰: Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: twitter-publisher-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - twitter-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # å¯é€‰: ç›‘æ§æœåŠ¡
  prometheus:
    image: prom/prometheus:latest
    container_name: twitter-publisher-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - twitter-net

  grafana:
    image: grafana/grafana:latest
    container_name: twitter-publisher-grafana
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./docker/grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - twitter-net

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:

networks:
  twitter-net:
    driver: bridge
```

### 2. Dockerfile

**docker/Dockerfile**:

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM python:3.11-slim as builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt requirements-prod.txt ./

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements-prod.txt

# ç”Ÿäº§é˜¶æ®µ
FROM python:3.11-slim as production

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶PythonåŒ…
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY app/ ./app/
COPY config/ ./config/
COPY scripts/ ./scripts/
COPY docker/entrypoint.sh ./

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p data logs projects && \
    chown -R appuser:appuser /app

# è®¾ç½®æ‰§è¡Œæƒé™
RUN chmod +x entrypoint.sh

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -m app.cli health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV APP_ENV=production

# å¯åŠ¨è„šæœ¬
ENTRYPOINT ["./entrypoint.sh"]
CMD ["api"]
```

### 3. å¯åŠ¨è„šæœ¬

**docker/entrypoint.sh**:

```bash
#!/bin/bash
set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸš€ å¯åŠ¨ Twitter Auto Publisher...${NC}"

# ç­‰å¾…æ•°æ®åº“å°±ç»ª (å¦‚æœä½¿ç”¨å¤–éƒ¨æ•°æ®åº“)
if [ "$DATABASE_URL" != "sqlite:///data/twitter_publisher.db" ]; then
    echo -e "${YELLOW}â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª...${NC}"
    python -c "
import time
import sys
from app.database.db_manager import DatabaseManager

for i in range(30):
    try:
        db = DatabaseManager()
        db.check_health()
        print('æ•°æ®åº“è¿æ¥æˆåŠŸ')
        break
    except Exception as e:
        print(f'ç­‰å¾…æ•°æ®åº“... ({i+1}/30): {e}')
        time.sleep(2)
else:
    print('æ•°æ®åº“è¿æ¥è¶…æ—¶')
    sys.exit(1)
"
fi

# åˆå§‹åŒ–æ•°æ®åº“
echo -e "${YELLOW}ğŸ“Š åˆå§‹åŒ–æ•°æ®åº“...${NC}"
python -m app.cli db init

# è¿è¡Œæ•°æ®åº“è¿ç§»
echo -e "${YELLOW}ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»...${NC}"
python -m app.cli db migrate

# éªŒè¯ç³»ç»Ÿé…ç½®
echo -e "${YELLOW}âœ… éªŒè¯ç³»ç»Ÿé…ç½®...${NC}"
python -m app.cli validate

# æ ¹æ®å‚æ•°å¯åŠ¨ä¸åŒæœåŠ¡
case "$1" in
    "api")
        echo -e "${GREEN}ğŸŒ å¯åŠ¨APIæœåŠ¡...${NC}"
        exec python -m app.api.main
        ;;
    "scheduler")
        echo -e "${GREEN}â° å¯åŠ¨è°ƒåº¦æœåŠ¡...${NC}"
        exec python -m app.cli scheduler start
        ;;
    "worker")
        echo -e "${GREEN}ğŸ‘· å¯åŠ¨å·¥ä½œè¿›ç¨‹...${NC}"
        exec python -m app.cli worker start
        ;;
    "web")
        echo -e "${GREEN}ğŸ–¥ï¸ å¯åŠ¨Webç•Œé¢...${NC}"
        exec python -m app.web.main
        ;;
    "all")
        echo -e "${GREEN}ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡...${NC}"
        # ä½¿ç”¨supervisoræˆ–ç±»ä¼¼å·¥å…·ç®¡ç†å¤šä¸ªè¿›ç¨‹
        exec python -m app.main
        ;;
    *)
        echo -e "${RED}âŒ æœªçŸ¥æœåŠ¡ç±»å‹: $1${NC}"
        echo "å¯ç”¨é€‰é¡¹: api, scheduler, worker, web, all"
        exit 1
        ;;
esac
```

### 4. å¼€å‘ç¯å¢ƒé…ç½®

**docker-compose.dev.yml**:

```yaml
version: '3.8'

services:
  twitter-publisher-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: twitter-publisher-dev
    ports:
      - "8080:8080"
      - "8080:8080"
      - "5678:5678"  # è°ƒè¯•ç«¯å£
    environment:
      - APP_ENV=development
      - APP_DEBUG=true
    env_file:
      - .env.dev
    volumes:
      - .:/app  # æŒ‚è½½æºä»£ç ç”¨äºå¼€å‘
      - /app/venv  # æ’é™¤è™šæ‹Ÿç¯å¢ƒ
    networks:
      - twitter-net
    command: >
      bash -c "pip install -e . &&
               python -m app.cli db init &&
               python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m app.api.main"

networks:
  twitter-net:
    driver: bridge
```

## æœ¬åœ°éƒ¨ç½²

### 1. ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+, CentOS 8+, macOS 10.15+, Windows 10+
- **Python**: 3.8+
- **å†…å­˜**: æœ€ä½ 2GBï¼Œæ¨è 4GB+
- **å­˜å‚¨**: æœ€ä½ 5GB å¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥

### 2. å®‰è£…æ­¥éª¤

#### Ubuntu/Debian

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…ç³»ç»Ÿä¾èµ–
sudo apt install -y python3 python3-pip python3-venv git curl wget

# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/twitter-auto-publisher.git
cd twitter-auto-publisher

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒ
cp .env.example .env
vim .env

# åˆå§‹åŒ–ç³»ç»Ÿ
python -m app.cli setup

# å¯åŠ¨æœåŠ¡
python -m app.main
```

#### CentOS/RHEL

```bash
# å®‰è£…EPELä»“åº“
sudo yum install -y epel-release

# å®‰è£…ç³»ç»Ÿä¾èµ–
sudo yum install -y python3 python3-pip git curl wget

# å…¶ä½™æ­¥éª¤åŒUbuntu
```

#### macOS

```bash
# å®‰è£…Homebrew (å¦‚æœæœªå®‰è£…)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# å®‰è£…Python
brew install python@3.11

# å…¶ä½™æ­¥éª¤åŒUbuntu
```

#### Windows

```powershell
# ä½¿ç”¨Chocolateyå®‰è£…Python
choco install python git

# æˆ–è€…ä»å®˜ç½‘ä¸‹è½½å®‰è£…
# https://www.python.org/downloads/

# å…‹éš†é¡¹ç›®
git clone https://github.com/your-org/twitter-auto-publisher.git
cd twitter-auto-publisher

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt

# é…ç½®å’Œå¯åŠ¨
copy .env.example .env
notepad .env
python -m app.cli setup
python -m app.main
```

### 3. ç³»ç»ŸæœåŠ¡é…ç½®

#### SystemdæœåŠ¡ (Linux)

**åˆ›å»ºæœåŠ¡æ–‡ä»¶** `/etc/systemd/system/twitter-publisher.service`:

```ini
[Unit]
Description=Twitter Auto Publisher
After=network.target
Wants=network.target

[Service]
Type=simple
User=twitter
Group=twitter
WorkingDirectory=/opt/twitter-publisher
Environment=PATH=/opt/twitter-publisher/venv/bin
EnvironmentFile=/opt/twitter-publisher/.env
ExecStart=/opt/twitter-publisher/venv/bin/python -m app.main
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
KillMode=mixed
TimeoutStopSec=30

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/twitter-publisher/data /opt/twitter-publisher/logs

# èµ„æºé™åˆ¶
LimitNOFILE=65536
LimitNPROC=4096

[Install]
WantedBy=multi-user.target
```

**å¯ç”¨å’Œç®¡ç†æœåŠ¡**:

```bash
# é‡è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡
sudo systemctl enable twitter-publisher

# å¯åŠ¨æœåŠ¡
sudo systemctl start twitter-publisher

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status twitter-publisher

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u twitter-publisher -f

# é‡å¯æœåŠ¡
sudo systemctl restart twitter-publisher

# åœæ­¢æœåŠ¡
sudo systemctl stop twitter-publisher
```

## äº‘ç«¯éƒ¨ç½²

### 1. AWSéƒ¨ç½²

#### EC2å®ä¾‹éƒ¨ç½²

```bash
# åˆ›å»ºEC2å®ä¾‹
aws ec2 run-instances \
    --image-id ami-0c02fb55956c7d316 \
    --instance-type t3.medium \
    --key-name your-key-pair \
    --security-group-ids sg-xxxxxxxxx \
    --subnet-id subnet-xxxxxxxxx \
    --user-data file://scripts/aws-user-data.sh

# ç”¨æˆ·æ•°æ®è„šæœ¬ (scripts/aws-user-data.sh)
#!/bin/bash
yum update -y
yum install -y python3 python3-pip git docker

# å¯åŠ¨Docker
systemctl start docker
systemctl enable docker
usermod -a -G docker ec2-user

# å®‰è£…Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# å…‹éš†å’Œéƒ¨ç½²åº”ç”¨
cd /opt
git clone https://github.com/your-org/twitter-auto-publisher.git
cd twitter-auto-publisher
cp .env.example .env

# é…ç½®ç¯å¢ƒå˜é‡ (ä»AWS Secrets Managerè·å–)
aws secretsmanager get-secret-value --secret-id twitter-publisher-secrets --query SecretString --output text > .env

# å¯åŠ¨æœåŠ¡
docker-compose up -d
```

#### ECSéƒ¨ç½²

**ä»»åŠ¡å®šä¹‰** (aws/task-definition.json):

```json
{
  "family": "twitter-publisher",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "executionRoleArn": "arn:aws:iam::account:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::account:role/ecsTaskRole",
  "containerDefinitions": [
    {
      "name": "twitter-publisher",
      "image": "your-account.dkr.ecr.region.amazonaws.com/twitter-publisher:latest",
      "portMappings": [
        {
          "containerPort": 8080,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "APP_ENV",
          "value": "production"
        }
      ],
      "secrets": [
        {
          "name": "TWITTER_API_KEY",
          "valueFrom": "arn:aws:secretsmanager:region:account:secret:twitter-api-key"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/twitter-publisher",
          "awslogs-region": "us-west-2",
          "awslogs-stream-prefix": "ecs"
        }
      },
      "healthCheck": {
        "command": [
          "CMD-SHELL",
          "python -m app.cli health || exit 1"
        ],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 60
      }
    }
  ]
}
```

### 2. Google Cloud Platforméƒ¨ç½²

#### Cloud Runéƒ¨ç½²

```bash
# æ„å»ºå’Œæ¨é€é•œåƒ
gcloud builds submit --tag gcr.io/PROJECT_ID/twitter-publisher

# éƒ¨ç½²åˆ°Cloud Run
gcloud run deploy twitter-publisher \
    --image gcr.io/PROJECT_ID/twitter-publisher \
    --platform managed \
    --region us-central1 \
    --allow-unauthenticated \
    --memory 1Gi \
    --cpu 1 \
    --max-instances 10 \
    --set-env-vars APP_ENV=production \
    --set-secrets TWITTER_API_KEY=twitter-api-key:latest
```

#### GKEéƒ¨ç½²

**Kubernetesé…ç½®** (k8s/deployment.yaml):

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: twitter-publisher
  labels:
    app: twitter-publisher
spec:
  replicas: 3
  selector:
    matchLabels:
      app: twitter-publisher
  template:
    metadata:
      labels:
        app: twitter-publisher
    spec:
      containers:
      - name: twitter-publisher
        image: gcr.io/PROJECT_ID/twitter-publisher:latest
        ports:
        - containerPort: 8080
        env:
        - name: APP_ENV
          value: "production"
        envFrom:
        - secretRef:
            name: twitter-publisher-secrets
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: twitter-publisher-service
spec:
  selector:
    app: twitter-publisher
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer
```

### 3. Azureéƒ¨ç½²

#### Container Instances

```bash
# åˆ›å»ºèµ„æºç»„
az group create --name twitter-publisher-rg --location eastus

# åˆ›å»ºå®¹å™¨å®ä¾‹
az container create \
    --resource-group twitter-publisher-rg \
    --name twitter-publisher \
    --image your-registry.azurecr.io/twitter-publisher:latest \
    --cpu 1 \
    --memory 2 \
    --ports 8080 \
    --environment-variables APP_ENV=production \
    --secure-environment-variables TWITTER_API_KEY=$TWITTER_API_KEY \
    --restart-policy Always
```

## è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨

### 1. Nginxè´Ÿè½½å‡è¡¡

**nginx.conf**:

```nginx
upstream twitter_publisher {
    least_conn;
    server 127.0.0.1:8001 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8002 weight=1 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8003 weight=1 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name your-domain.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://twitter_publisher;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # é™æ€æ–‡ä»¶
    location /static/ {
        alias /opt/twitter-publisher/app/web/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://twitter_publisher/health;
        access_log off;
    }
    
    # é™æµ
    location /api/auth/ {
        limit_req zone=auth burst=5 nodelay;
        proxy_pass http://twitter_publisher;
    }
}

# é™æµé…ç½®
http {
    limit_req_zone $binary_remote_addr zone=auth:10m rate=1r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
}
```

### 2. HAProxyé…ç½®

**haproxy.cfg**:

```
global
    daemon
    maxconn 4096
    log stdout local0
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option redispatch
    retries 3
    
frontend twitter_publisher_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/your-domain.pem
    redirect scheme https if !{ ssl_fc }
    
    # ACLè§„åˆ™
    acl is_api path_beg /api/
    acl is_health path /health
    
    # è·¯ç”±è§„åˆ™
    use_backend twitter_publisher_api if is_api
    use_backend twitter_publisher_health if is_health
    default_backend twitter_publisher_web
    
backend twitter_publisher_api
    balance roundrobin
    option httpchk GET /health
    server api1 127.0.0.1:8001 check
    server api2 127.0.0.1:8002 check
    server api3 127.0.0.1:8003 check
    
backend twitter_publisher_web
    balance roundrobin
    option httpchk GET /health
    server web1 127.0.0.1:8081 check
    server web2 127.0.0.1:8082 check
    
backend twitter_publisher_health
    balance roundrobin
    server health1 127.0.0.1:8001 check
    server health2 127.0.0.1:8002 check
    server health3 127.0.0.1:8003 check
```

## ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨ç›‘æ§

#### Prometheusé…ç½®

**docker/prometheus.yml**:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'twitter-publisher'
    static_configs:
      - targets: ['twitter-publisher:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
      
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['postgres-exporter:9187']
```

#### å‘Šè­¦è§„åˆ™

**docker/alert_rules.yml**:

```yaml
groups:
  - name: twitter_publisher_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
          
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 > 500
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}MB"
          
      - alert: ServiceDown
        expr: up{job="twitter-publisher"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "Twitter Publisher service is not responding"
```

### 2. æ—¥å¿—ç®¡ç†

#### ELK Stacké…ç½®

**docker/elasticsearch.yml**:

```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.8.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - elk
      
  logstash:
    image: docker.elastic.co/logstash/logstash:8.8.0
    container_name: logstash
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
      - ./logs:/logs
    ports:
      - "5044:5044"
    networks:
      - elk
    depends_on:
      - elasticsearch
      
  kibana:
    image: docker.elastic.co/kibana/kibana:8.8.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    networks:
      - elk
    depends_on:
      - elasticsearch

volumes:
  elasticsearch_data:

networks:
  elk:
    driver: bridge
```

## å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# UFW (Ubuntu)
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# ä»…å…è®¸ç‰¹å®šIPè®¿é—®ç®¡ç†ç«¯å£
sudo ufw allow from 192.168.1.0/24 to any port 8080

# iptables (CentOS/RHEL)
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -j DROP
sudo iptables-save > /etc/iptables/rules.v4
```

### 2. SSL/TLSé…ç½®

```bash
# ä½¿ç”¨Let's Encryptè·å–å…è´¹SSLè¯ä¹¦
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. å®‰å…¨åŠ å›º

```bash
# ç¦ç”¨rootç™»å½•
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# æ›´æ”¹SSHç«¯å£
sudo sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config

# ç¦ç”¨å¯†ç ç™»å½•ï¼Œä»…ä½¿ç”¨å¯†é’¥
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd

# å®‰è£…fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

## å¤‡ä»½å’Œæ¢å¤

### 1. æ•°æ®å¤‡ä»½

**å¤‡ä»½è„šæœ¬** (scripts/backup.sh):

```bash
#!/bin/bash

BACKUP_DIR="/opt/backups/twitter-publisher"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="twitter_publisher_backup_$DATE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
echo "å¤‡ä»½æ•°æ®åº“..."
sqlite3 /opt/twitter-publisher/data/twitter_publisher.db ".backup $BACKUP_DIR/${BACKUP_NAME}.db"

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
tar -czf $BACKUP_DIR/${BACKUP_NAME}_config.tar.gz -C /opt/twitter-publisher config/ .env

# å¤‡ä»½é¡¹ç›®æ•°æ®
echo "å¤‡ä»½é¡¹ç›®æ•°æ®..."
tar -czf $BACKUP_DIR/${BACKUP_NAME}_projects.tar.gz -C /opt/twitter-publisher projects/

# å¤‡ä»½æ—¥å¿—
echo "å¤‡ä»½æ—¥å¿—..."
tar -czf $BACKUP_DIR/${BACKUP_NAME}_logs.tar.gz -C /opt/twitter-publisher logs/

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™30å¤©)
find $BACKUP_DIR -name "twitter_publisher_backup_*" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_NAME"
```

### 2. è‡ªåŠ¨å¤‡ä»½

```bash
# æ·»åŠ åˆ°crontab
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /opt/twitter-publisher/scripts/backup.sh

# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹å¤‡ä»½åˆ°äº‘å­˜å‚¨
0 3 * * 0 /opt/twitter-publisher/scripts/backup_to_cloud.sh
```

### 3. æ¢å¤è„šæœ¬

**æ¢å¤è„šæœ¬** (scripts/restore.sh):

```bash
#!/bin/bash

if [ $# -ne 1 ]; then
    echo "ç”¨æ³•: $0 <backup_name>"
    echo "å¯ç”¨å¤‡ä»½:"
    ls /opt/backups/twitter-publisher/
    exit 1
fi

BACKUP_NAME=$1
BACKUP_DIR="/opt/backups/twitter-publisher"
APP_DIR="/opt/twitter-publisher"

# åœæ­¢æœåŠ¡
echo "åœæ­¢æœåŠ¡..."
sudo systemctl stop twitter-publisher

# æ¢å¤æ•°æ®åº“
echo "æ¢å¤æ•°æ®åº“..."
cp $APP_DIR/data/twitter_publisher.db $APP_DIR/data/twitter_publisher.db.backup
sqlite3 $APP_DIR/data/twitter_publisher.db ".restore $BACKUP_DIR/${BACKUP_NAME}.db"

# æ¢å¤é…ç½®
echo "æ¢å¤é…ç½®..."
tar -xzf $BACKUP_DIR/${BACKUP_NAME}_config.tar.gz -C $APP_DIR/

# æ¢å¤é¡¹ç›®æ•°æ®
echo "æ¢å¤é¡¹ç›®æ•°æ®..."
tar -xzf $BACKUP_DIR/${BACKUP_NAME}_projects.tar.gz -C $APP_DIR/

# è®¾ç½®æƒé™
chown -R twitter:twitter $APP_DIR

# å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
sudo systemctl start twitter-publisher

# éªŒè¯æ¢å¤
echo "éªŒè¯æ¢å¤..."
sleep 10
python -m app.cli health

echo "æ¢å¤å®Œæˆ"
```

---

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [æ•…éšœæ’é™¤æŒ‡å—](07_æ•…éšœæ’é™¤.md) äº†è§£å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ³•ã€‚