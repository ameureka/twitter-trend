# Twitter 自动发布系统 - 端口配置标准文档

## 文档概述

本文档详细记录了 Twitter 自动发布系统中所有服务的端口配置标准，包括端口分配、配置文件位置、环境变量设置等信息。

**文档版本**: v2.0  
**最后更新**: 2025-01-15  
**更新内容**: 架构调整 - 前端服务通过API服务提供，统一使用8050端口

---

## 端口分配标准

### 核心服务端口

| 服务名称 | 端口号 | 协议 | 用途 | 备注 |
|---------|--------|------|------|------|
| **API服务** | **8050** | HTTP | RESTful API接口 + 前端界面 | 统一服务架构，包含API和前端 |
| **数据库** | 5432 | TCP | PostgreSQL数据库 | 仅远程数据库时使用 |

**注意**: 本系统采用单服务架构，前端界面通过API服务提供，统一使用8050端口访问。

### 监控服务端口

| 服务名称 | 端口号 | 协议 | 用途 | 备注 |
|---------|--------|------|------|------|
| **Prometheus** | 9090 | HTTP | 指标收集和监控 | 系统监控 |
| **Grafana** | 3000 | HTTP | 监控仪表板 | 数据可视化 |

### 邮件服务端口

| 服务名称 | 端口号 | 协议 | 用途 | 备注 |
|---------|--------|------|------|------|
| **SMTP** | 587 | TCP | 邮件发送服务 | 通知和报告 |

### 生产环境端口

| 服务名称 | 端口号 | 协议 | 用途 | 备注 |
|---------|--------|------|------|------|
| **HTTP** | 80 | HTTP | 标准Web访问 | 生产环境前端 |
| **HTTPS** | 443 | HTTPS | 安全Web访问 | SSL/TLS加密 |

---

## 配置文件位置

### 主配置文件

1. **`config/enhanced_config.yaml`** - 主要配置文件
   ```yaml
   ports:
     api_port: 8050  # 统一服务端口（API + 前端）
     prometheus_port: 9090
     grafana_port: 3000
   ```

2. **`config/ports.yaml`** - 端口专用配置文件
   ```yaml
   api:
     port: 8050  # 统一服务端口（API + 前端）
     host: "0.0.0.0"
   ```

3. **`config/enhanced_config_test.yaml`** - 测试环境配置
   ```yaml
   ports:
     api_port: 8050  # 统一服务端口（API + 前端）
   ```

### 代码配置文件

1. **`api/dependencies.py`** - API服务依赖配置
   ```python
   class APISettings(BaseSettings):
       api_host: str = "127.0.0.1"
       api_port: int = 8050
   ```

2. **`app/utils/enhanced_config.py`** - 增强配置管理
   ```python
   'api.port': 8050,
   'port': 8050,
   ```

### 部署配置文件

1. **`docker-compose.yml`** - Docker容器配置
   ```yaml
   ports:
     - "8050:8050"  # API服务端口映射
   healthcheck:
     test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8050/health')"]
   ```

2. **`Dockerfile`** - Docker镜像配置
   ```dockerfile
   EXPOSE 8050
   CMD python -c "import requests; requests.get('http://localhost:8050/health')" || exit 1
   ```

3. **`config/prometheus.yml`** - Prometheus监控配置
   ```yaml
   static_configs:
     - targets: ['localhost:8050']
   ```

### 启动脚本配置

1. **`start_api.sh`** - API服务启动脚本
   ```bash
   PORT="8050"  # 默认端口
   ```

2. **`scripts/start.py`** - Python启动脚本
   ```python
   def start_api_server(host='127.0.0.1', port=8050, reload=False):
   parser.add_argument('--port', type=int, default=8050, help='API服务器端口')
   ```

3. **`scripts/server/start_api.py`** - 服务器启动管理
   ```python
   default=int(os.getenv('API_PORT', 8050)),
   help='服务器端口（默认: 8050）'
   ```

---

## 环境变量配置

### API服务环境变量

```bash
# 统一服务配置（API + 前端）
API_HOST=127.0.0.1
API_PORT=8050
API_DEBUG=false

# 监控服务配置
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000

# 邮件服务配置
SMTP_PORT=587
```

### 环境变量优先级

1. **环境变量** (最高优先级)
2. **YAML配置文件**
3. **代码默认值** (最低优先级)

---

## 端口使用场景

### 开发环境

- **统一访问地址**: `http://localhost:8050`
- **前端界面**: `http://localhost:8050/`
- **API接口**: `http://localhost:8050/api/`
- **API文档**: `http://localhost:8050/docs`
- **健康检查**: `http://localhost:8050/api/health`

### 生产环境

- **统一访问地址**: `http://your-domain:8050`
- **前端界面**: `http://your-domain:8050/`
- **API接口**: `http://your-domain:8050/api/`
- **HTTPS访问**: `https://your-domain` (端口443，通过反向代理)
- **监控面板**: `http://your-domain:3000`

### Docker环境

```bash
# 启动容器
docker-compose up -d

# 访问服务
curl http://localhost:8050/api/health  # API健康检查
curl http://localhost:8050/            # 前端界面
```

---

## 端口冲突解决

### 检查端口占用

```bash
# 检查端口是否被占用
lsof -i :8050  # 检查统一服务端口
netstat -tuln | grep :8050
```

### 修改端口配置

1. **临时修改** (环境变量)
   ```bash
   export API_PORT=8051  # 修改统一服务端口
   ```

2. **永久修改** (配置文件)
   - 修改 `config/enhanced_config.yaml`
   - 修改 `config/ports.yaml`
   - 重启服务

---

## 安全配置建议

### 防火墙配置

```bash
# 允许统一服务端口访问（API + 前端）
sudo ufw allow 8050/tcp

# 限制监控端口访问（仅内网）
sudo ufw allow from 192.168.1.0/24 to any port 9090
sudo ufw allow from 192.168.1.0/24 to any port 3000
```

### 反向代理配置 (Nginx)

```nginx
# 统一服务代理（API + 前端）
location / {
    proxy_pass http://localhost:8050/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

---

## 监控和日志

### 端口监控

```bash
# 实时监控端口状态
watch -n 5 'netstat -tuln | grep -E ":(8050|9090|3000)"'

# 检查服务健康状态
curl -f http://localhost:8050/api/health || echo "API服务异常"
curl -f http://localhost:8050/ || echo "前端界面异常"
```

### 日志位置

- **API服务日志**: `logs/app.log`
- **Docker日志**: `docker logs twitter-publisher`
- **系统日志**: `/var/log/syslog`

---

## 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   # 查找占用进程
   lsof -i :8050
   # 终止进程
   kill -9 <PID>
   ```

2. **配置不生效**
   - 检查配置文件语法
   - 确认环境变量设置
   - 重启服务

3. **Docker端口映射问题**
   ```bash
   # 重新构建容器
   docker-compose down
   docker-compose up --build
   ```

### 测试命令

```bash
# 测试API服务
curl -H "X-API-Key: your_api_key" http://localhost:8050/api/health

# 测试前端界面
curl http://localhost:8050/

# 测试监控服务
curl http://localhost:9090/metrics
curl http://localhost:3000
```

---

## 更新历史

| 版本 | 日期 | 更新内容 | 更新人 |
|------|------|----------|--------|
| v2.0 | 2025-01-15 | 架构调整：前端服务通过API服务提供，统一使用8050端口 | System |
| v1.0 | 2025-01-15 | 端口重新分配：API 8080→8050，前端保持8080 | System |

---

## 联系信息

如有端口配置相关问题，请参考本文档或联系系统管理员。

**注意**: 修改端口配置后，请务必更新相关文档和通知相关人员。