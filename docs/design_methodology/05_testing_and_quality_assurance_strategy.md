# 5. 测试与质量保证策略

本文档概述了为确保 "Twitter 自动发布管理系统" 的质量、稳定性和可靠性而制定的测试策略和质量保证（QA）流程。一个没有经过充分测试的系统是脆弱的，因此，测试是开发流程中不可或缺的一环。

## 5.1. 测试理念：测试金字塔

我们遵循经典的“测试金字塔”模型，将测试资源合理地分配到不同层级的测试中，以实现成本和效益的最佳平衡。

```
      /\
     /  \
    / E2E \
   /-------\
  / Integration \
 /---------------\
/   Unit Tests    \
-------------------
```

-   **单元测试 (Unit Tests)**: 构成金字塔的基石。它们数量最多，运行速度最快。单元测试专注于测试单一的、孤立的函数或类（一个“单元”），确保其在各种输入下都能按预期工作。例如，测试一个用于格式化推文文本的函数。
-   **集成测试 (Integration Tests)**: 位于金字塔的中间层。它们测试多个模块组合在一起时是否能协同工作。例如，测试“API路由层”能否正确调用“业务逻辑层”，并由“数据访问层”成功写入数据库。
-   **端到端测试 (End-to-End, E2E Tests)**: 位于金字塔的顶端。它们数量最少，运行最慢，但价值最高。E2E 测试从用户的视角出发，模拟真实的用户操作流程，贯穿整个技术栈（前端 -> 后端 -> 数据库 -> 外部服务），以验证一个完整的功能是否正常。例如，模拟用户登录、创建一个新项目、上传视频、生成任务、并最终验证推文是否成功发布到 Twitter。

## 5.2. 后端测试策略

后端测试使用 **Pytest** 作为测试框架，因为它功能强大、插件丰富且易于使用。

### 5.2.1. 单元测试

-   **目标**: 测试 `app/utils/` 和 `app/core/` 中的独立业务逻辑单元。
-   **工具**: `pytest`, `pytest-mock` (用于模拟依赖项)。
-   **示例**: 
    -   测试 `ContentGenerator` 中的一个函数，给定一个特定的 JSON 输入，是否能生成符合预期的文本输出。
    -   测试 `path_manager.py` 中的路径处理函数，在不同操作系统（模拟）下是否能正确拼接路径。
-   **关键实践**: 
    -   **隔离性**: 单元测试绝不能触及文件系统、数据库或网络。所有外部依赖都必须被“模拟”（Mock）掉。例如，当测试一个需要写入文件的函数时，我们会模拟 `open()` 函数，使其写入一个内存中的字符串流，而不是真实的磁盘。

### 5.2.2. 集成测试

-   **目标**: 测试模块间的交互，特别是 API 层、业务逻辑层和数据访问层之间的协作。
-   **工具**: `pytest`, `FastAPI TestClient`, 内存中的 SQLite 数据库。
-   **示例**: 
    -   使用 `TestClient` 向 `/api/tasks/` 端点发送一个 POST 请求，然后查询测试数据库，验证是否已正确创建了一条新的任务记录。
    -   调用一个业务逻辑服务，该服务会与数据库交互，然后验证数据库的状态是否按预期发生了变化。
-   **关键实践**: 
    -   **独立的测试数据库**: 所有集成测试都在一个独立的、内存中的 SQLite 数据库上运行。每个测试用例开始时创建数据库，结束时销毁，确保测试用例之间互不干扰。

## 5.3. 前端测试策略

前端的复杂性和交互性要求我们采用不同的测试方法。

### 5.3.1. 手动测试与调试

对于本项目规模的前端，我们主要依赖于结构化的手动测试和强大的浏览器开发者工具。

-   **核心工具**: **Playwright**。Playwright 不仅可以用于自动化的 E2E 测试，其 `codegen` 功能也是一个强大的半自动化测试和调试工具。我们可以手动在浏览器中操作，Playwright 会自动录制这些操作并生成测试脚本。这对于快速验证一个复杂的用户流程非常高效。
-   **调试经验**: 
    1.  **网络面板 (Network Tab)**: 这是最重要的调试工具。所有前后端的问题，第一步都是检查网络面板。查看 API 请求的 URL、方法、请求体是否正确，以及服务器返回的状态码和响应内容是什么。90% 的问题都能在这里定位到是前端发错了请求，还是后端返回了错误的数据。
    2.  **控制台 (Console Tab)**: 检查是否有 JavaScript 运行时错误。利用 `console.log()` 在代码的关键节点输出变量和状态，是追踪逻辑执行流程最直接有效的方法。
    3.  **组件状态检查**: 对于使用 Alpine.js 的组件，可以在控制台通过 `Alpine.store('storeName')` 或在元素上直接访问 `$data` 来检查组件的当前状态，验证数据是否按预期绑定。

### 5.3.2. 端到端测试 (E2E)

-   **目标**: 验证完整的用户故事（User Story）。
-   **工具**: **Playwright**。
-   **示例**: 
    1.  **测试日志管理功能**: 
        a.  启动应用。
        b.  使用 Playwright 导航到日志视图。
        c.  模拟在筛选框中输入“error”。
        d.  断言（Assert）表格中只显示了包含“error”文本的行。
        e.  模拟点击“导出 CSV”按钮。
        f.  验证一个名为 `logs.csv` 的文件是否已下载。
-   **关键实践**: 
    -   **模拟后端 API**: 在纯前端的 E2E 测试中，我们会拦截所有对后端 API 的 `fetch` 请求，并返回预设的模拟数据。这使得我们可以在不依赖真实后端的情况下独立测试前端应用的逻辑和渲染。

## 5.4. 质量保证流程

1.  **代码审查 (Code Review)**: 所有新代码在合并到主分支之前，都必须经过至少一位其他团队成员的审查。审查内容包括代码风格、逻辑正确性、是否遵循设计原则以及是否有相应的测试覆盖。
2.  **持续集成 (Continuous Integration - CI)**: (未来规划) 当代码推送到代码仓库时，CI 服务器（如 GitHub Actions）会自动执行所有的单元测试和集成测试。只有当所有测试通过时，代码才被允许合并。
3.  **预发布环境 (Staging)**: 在部署到生产环境之前，代码会先部署到一个与生产环境配置完全一致的预发布环境中，进行最后的 E2E 测试和手动回归测试。

## 5.5. 总结

质量不是在开发结束后“测试”出来的，而是在整个开发生命周期中“构建”进去的。通过结合使用单元测试、集成测试和端到端测试，并辅以严格的代码审查和结构化的手动测试流程，我们旨在构建一个功能正确、行为稳定且易于维护的高质量系统。这套策略确保了我们能够自信地进行功能迭代和代码重构，而不必担心破坏现有功能。