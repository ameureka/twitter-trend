# Twitter è‡ªåŠ¨å‘å¸ƒç³»ç»Ÿï¼šå…¨é¢æµ‹è¯•æ–¹æ¡ˆ

åŸºäºé¡¹ç›®çš„å®é™…æ¶æ„å’ŒåŠŸèƒ½å®ç°ï¼Œæœ¬æ–‡æ¡£æä¾›äº†ä¸€å¥—å®Œæ•´çš„ã€åˆ†å±‚çš„ã€å¯æ‰§è¡Œçš„æµ‹è¯•æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆæ¶µç›–å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œç¡®ä¿ç³»ç»Ÿçš„è´¨é‡ã€åŠŸèƒ½æ­£ç¡®æ€§å’Œé•¿æœŸå¯ç»´æŠ¤æ€§ã€‚

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

å½“å‰é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…æ‹¬ï¼š
- **APIå±‚** (`api/`): FastAPIåº”ç”¨ï¼ŒåŒ…å«è®¤è¯ã€ä»ªè¡¨æ¿ã€ä»»åŠ¡å’Œé¡¹ç›®ç®¡ç†è·¯ç”±
- **æ ¸å¿ƒä¸šåŠ¡å±‚** (`app/core/`): å†…å®¹ç”Ÿæˆå™¨ã€å‘å¸ƒå™¨ã€é¡¹ç›®ç®¡ç†å™¨ã€ä»»åŠ¡è°ƒåº¦å™¨
- **æ•°æ®åº“å±‚** (`app/database/`): SQLAlchemyæ¨¡å‹ã€ä»“åº“æ¨¡å¼ã€æ•°æ®åº“ç®¡ç†
- **å·¥å…·å±‚** (`app/utils/`): é…ç½®ç®¡ç†ã€æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ã€é‡è¯•æœºåˆ¶
- **å‰ç«¯** (`frontend/`): ç®€å•çš„Webç•Œé¢
- **è„šæœ¬** (`scripts/`): å¯åŠ¨è„šæœ¬å’Œå·¥å…·

---

#### **ä¸€ã€ æµ‹è¯•æ ¸å¿ƒåŸåˆ™ä¸ç­–ç•¥**

1.  **æµ‹è¯•ç‹¬ç«‹æ€§**:
    *   **ç‹¬ç«‹æµ‹è¯•æ¨¡å—**: æ‰€æœ‰æµ‹è¯•ä»£ç å°†æ”¾ç½®åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ `tests/` ç›®å½•ä¸‹ï¼Œä¸ `app/` æºä»£ç å®Œå…¨åˆ†ç¦»ã€‚
    *   **ç‹¬ç«‹æµ‹è¯•æ•°æ®åº“**: æµ‹è¯•è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€å†…å­˜ä¸­çš„ SQLite æ•°æ®åº“ï¼ˆæˆ–ä¸€ä¸ªä¸´æ—¶çš„æµ‹è¯•æ–‡ä»¶ï¼‰ï¼Œç»ä¸ä½¿ç”¨ç”Ÿäº§æ•°æ®åº“ã€‚æ¯æ¬¡æµ‹è¯•è¿è¡Œå¼€å§‹æ—¶åˆ›å»ºï¼Œç»“æŸåé”€æ¯ï¼Œç¡®ä¿æµ‹è¯•ä¹‹é—´äº’ä¸å¹²æ‰°ã€‚
    *   **ç‹¬ç«‹æµ‹è¯•é…ç½®**: æµ‹è¯•å°†åŠ è½½ä¸€å¥—ç‹¬ç«‹çš„æµ‹è¯•é…ç½®æ–‡ä»¶ (`tests/config.test.yaml`)ï¼Œè¦†ç›–ä¸»é…ç½®ï¼Œä»¥ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„å‚æ•°ã€‚

2.  **åˆ†å±‚æµ‹è¯• (Testing Pyramid)**:
    *   **å•å…ƒæµ‹è¯• (Unit Tests)**: å æœ€å¤§æ¯”ä¾‹ã€‚ä¸“æ³¨äºæµ‹è¯•å•ä¸ªå‡½æ•°æˆ–ç±»çš„æœ€å°é€»è¾‘å•å…ƒï¼Œé€Ÿåº¦å¿«ï¼Œéš”ç¦»æ€§å¥½ã€‚ä½¿ç”¨ Mockï¼ˆæ¨¡æ‹Ÿï¼‰å¯¹è±¡æ¥æ›¿ä»£å¤–éƒ¨ä¾èµ–ï¼ˆå¦‚æ•°æ®åº“ã€APIï¼‰ã€‚
    *   **é›†æˆæµ‹è¯• (Integration Tests)**: æµ‹è¯•å¤šä¸ªç»„ä»¶ååŒå·¥ä½œçš„æ­£ç¡®æ€§ã€‚ä¾‹å¦‚ï¼Œæµ‹è¯•â€œå†…å®¹ç”Ÿæˆå™¨â€å’Œâ€œä»»åŠ¡åˆ›å»ºé€»è¾‘â€èƒ½å¦æ­£ç¡®åœ°å°† JSON è§£æå¹¶å­˜å…¥çœŸå®çš„ï¼ˆæµ‹è¯•ï¼‰æ•°æ®åº“ã€‚
    *   **ç«¯åˆ°ç«¯æµ‹è¯• (E2E Tests)**: å æœ€å°æ¯”ä¾‹ï¼Œä½†è‡³å…³é‡è¦ã€‚æ¨¡æ‹ŸçœŸå®çš„ç”¨æˆ·æ“ä½œæµç¨‹ï¼Œä»è°ƒç”¨ CLI å‘½ä»¤å¼€å§‹ï¼Œåˆ°æ£€æŸ¥æ•°æ®åº“çŠ¶æ€ï¼Œç”šè‡³ï¼ˆåœ¨ä¸¥æ ¼æ§åˆ¶ä¸‹ï¼‰ä¸çœŸå®çš„å¤–éƒ¨ API äº¤äº’ï¼ŒéªŒè¯æ•´ä¸ªç³»ç»Ÿçš„å®Œæ•´æµç¨‹ã€‚

3.  **çœŸå®æ€§ä¸æ¨¡æ‹Ÿçš„å¹³è¡¡**:
    *   **å°½å¯èƒ½çœŸå®**: å¯¹äºç³»ç»Ÿå†…éƒ¨é€»è¾‘ï¼Œå¦‚æ•°æ®åº“äº¤äº’ã€æ–‡ä»¶è§£æã€ä¸šåŠ¡è§„åˆ™è®¡ç®—ï¼Œå¿…é¡»ä½¿ç”¨çœŸå®çš„ï¼ˆæµ‹è¯•ï¼‰æ•°æ®å’Œé…ç½®è¿›è¡ŒéªŒè¯ã€‚
    *   **æ˜æ™ºåœ°æ¨¡æ‹Ÿ**: å¯¹äºå¤–éƒ¨ä¾èµ–ï¼Œç‰¹åˆ«æ˜¯é‚£äº›æœ‰æˆæœ¬ã€æœ‰é€Ÿç‡é™åˆ¶æˆ–ä¸ç¨³å®šçš„æœåŠ¡ï¼ˆTwitter API, Gemini APIï¼‰ï¼Œåœ¨å•å…ƒå’Œé›†æˆæµ‹è¯•ä¸­å¿…é¡»ä½¿ç”¨ Mockã€‚åªåœ¨ä¸“é—¨çš„ã€æ ‡è®°æ¸…æ™°çš„ E2E æµ‹è¯•ä¸­æ‰è¿æ¥çœŸå®æœåŠ¡ã€‚

4.  **æµ‹è¯•å·¥å…·æ ˆ**:
    *   **æµ‹è¯•æ¡†æ¶**: **`pytest`** - åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒ Fixturesã€å‚æ•°åŒ–ã€æ’ä»¶ï¼Œæ˜¯ Python æµ‹è¯•çš„äº‹å®æ ‡å‡†ã€‚
    *   **æ¨¡æ‹Ÿåº“**: **`unittest.mock`** (Python å†…ç½®) æˆ– **`pytest-mock`** - ç”¨äºåˆ›å»º Mock å¯¹è±¡ã€‚
    *   **æ•°æ®åº“æµ‹è¯•**: SQLAlchemy + `pytest` Fixturesï¼Œç”¨äºç®¡ç†æµ‹è¯•æ•°æ®åº“çš„ç”Ÿå‘½å‘¨æœŸã€‚
    *   **CLI æµ‹è¯•**: `pytest` + `click.testing.CliRunner` - ç”¨äºåœ¨æµ‹è¯•ä¸­è°ƒç”¨å’Œæ–­è¨€å‘½ä»¤è¡Œåº”ç”¨çš„è¡Œä¸ºã€‚
    *   **è¦†ç›–ç‡å·¥å…·**: **`pytest-cov`** - ç”¨äºè¡¡é‡æµ‹è¯•å¯¹ä»£ç çš„è¦†ç›–ç¨‹åº¦ã€‚

#### **äºŒã€ æµ‹è¯•ç¯å¢ƒæ­å»º**

1.  **æµ‹è¯•æ–‡ä»¶ç»“æ„**:
    ```
    twitter-trend/
    â”œâ”€â”€ app/                     # æºä»£ç 
    â”œâ”€â”€ api/                     # APIæºä»£ç 
    â”œâ”€â”€ tests/                   # æµ‹è¯•ç›®å½•
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ conftest.py          # å…¨å±€æµ‹è¯•é…ç½®å’Œ Fixtures
    â”‚   â”œâ”€â”€ test_data/           # æµ‹è¯•æ•°æ®
    â”‚   â”‚   â”œâ”€â”€ projects/
    â”‚   â”‚   â”‚   â””â”€â”€ test_project/
    â”‚   â”‚   â”‚       â”œâ”€â”€ output_video_music/
    â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ sample_video_01.mp4
    â”‚   â”‚   â”‚       â”‚   â””â”€â”€ sample_video_02.mp4
    â”‚   â”‚   â”‚       â””â”€â”€ uploader_json/
    â”‚   â”‚   â”‚           â”œâ”€â”€ en_prompt_results_batch.json
    â”‚   â”‚   â”‚           â””â”€â”€ cn_prompt_results_batch.json
    â”‚   â”‚   â”œâ”€â”€ config/
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_config.yaml
    â”‚   â”‚   â”‚   â””â”€â”€ test.env
    â”‚   â”‚   â””â”€â”€ fixtures/
    â”‚   â”‚       â”œâ”€â”€ sample_metadata.json
    â”‚   â”‚       â””â”€â”€ mock_responses.json
    â”‚   â”œâ”€â”€ unit/                # å•å…ƒæµ‹è¯•
    â”‚   â”‚   â”œâ”€â”€ core/
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_content_generator.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_publisher.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_project_manager.py
    â”‚   â”‚   â”‚   â””â”€â”€ test_task_scheduler.py
    â”‚   â”‚   â”œâ”€â”€ database/
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_models.py
    â”‚   â”‚   â”‚   â””â”€â”€ test_repository.py
    â”‚   â”‚   â”œâ”€â”€ utils/
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_config.py
    â”‚   â”‚   â”‚   â”œâ”€â”€ test_logger.py
    â”‚   â”‚   â”‚   â””â”€â”€ test_file_handler.py
    â”‚   â”‚   â””â”€â”€ api/
    â”‚   â”‚       â”œâ”€â”€ test_dependencies.py
    â”‚   â”‚       â”œâ”€â”€ test_middleware.py
    â”‚   â”‚       â””â”€â”€ routers/
    â”‚   â”‚           â”œâ”€â”€ test_auth.py
    â”‚   â”‚           â”œâ”€â”€ test_dashboard.py
    â”‚   â”‚           â”œâ”€â”€ test_projects.py
    â”‚   â”‚           â””â”€â”€ test_tasks.py
    â”‚   â”œâ”€â”€ integration/         # é›†æˆæµ‹è¯•
    â”‚   â”‚   â”œâ”€â”€ test_api_integration.py
    â”‚   â”‚   â”œâ”€â”€ test_database_operations.py
    â”‚   â”‚   â”œâ”€â”€ test_content_pipeline.py
    â”‚   â”‚   â””â”€â”€ test_scheduler_integration.py
    â”‚   â””â”€â”€ e2e/                 # ç«¯åˆ°ç«¯æµ‹è¯•
    â”‚       â”œâ”€â”€ test_cli_workflows.py
    â”‚       â”œâ”€â”€ test_api_workflows.py
    â”‚       â””â”€â”€ test_full_publishing_flow.py
    â”‚
    â”œâ”€â”€ pytest.ini               # pytest é…ç½®æ–‡ä»¶
    â”œâ”€â”€ requirements-test.txt    # æµ‹è¯•ä¸“ç”¨ä¾èµ–
    â””â”€â”€ ...
    ```

2.  **`pytest.ini` é…ç½®**:
    ```ini
    [pytest]
    minversion = 6.0
    testpaths = tests
    addopts = -ra -q --cov=app --cov-report=term-missing
    markers = 
        e2e: marks tests as end-to-end (heavy, may involve real APIs)
        slow: marks tests as slow running
    ```

3.  **æ ¸å¿ƒ Fixture (`tests/conftest.py`)**:
    ```python
    import pytest
    import os
    import tempfile
    import shutil
    from pathlib import Path
    from sqlalchemy import create_engine
    from sqlalchemy.orm import sessionmaker
    from fastapi.testclient import TestClient
    from click.testing import CliRunner
    
    from app.database.models import Base, User, Project
    from app.database.repository import UserRepository
    from app.utils.config import ConfigManager
    from api.main import app
    from api.dependencies import get_db, get_config

    @pytest.fixture(scope="session")
    def test_db_engine():
        """åˆ›å»ºæµ‹è¯•æ•°æ®åº“å¼•æ“"""
        return create_engine("sqlite:///:memory:", echo=False)

    @pytest.fixture(scope="function")
    def db_session(test_db_engine):
        """ä¸ºæ¯ä¸ªæµ‹è¯•å‡½æ•°åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯"""
        connection = test_db_engine.connect()
        transaction = connection.begin()
        Base.metadata.create_all(connection)
        Session = sessionmaker(bind=connection)
        session = Session()
        
        # åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        user_repo = UserRepository(session)
        test_user = user_repo.create({
            'username': 'test_user',
            'role': 'admin'
        })
        session.commit()
        
        yield session
        
        session.close()
        transaction.rollback()
        connection.close()

    @pytest.fixture
    def test_config():
        """æµ‹è¯•é…ç½®"""
        config_data = {
            'database': {'url': 'sqlite:///:memory:'},
            'twitter': {
                'api_key': 'test_key',
                'api_secret': 'test_secret',
                'access_token': 'test_token',
                'access_token_secret': 'test_token_secret'
            },
            'gemini': {'api_key': 'test_gemini_key'},
            'scheduler': {
                'interval_minutes_min': 1,
                'interval_minutes_max': 2,
                'max_retries': 3
            },
            'logging': {'level': 'DEBUG'}
        }
        return ConfigManager(config_data=config_data)

    @pytest.fixture
    def test_client(db_session, test_config):
        """FastAPIæµ‹è¯•å®¢æˆ·ç«¯"""
        def override_get_db():
            yield db_session
        
        def override_get_config():
            return test_config
            
        app.dependency_overrides[get_db] = override_get_db
        app.dependency_overrides[get_config] = override_get_config
        
        with TestClient(app) as client:
            yield client
            
        app.dependency_overrides.clear()

    @pytest.fixture
    def cli_runner():
        """CLIæµ‹è¯•è¿è¡Œå™¨"""
        return CliRunner()

    @pytest.fixture
    def temp_project_dir():
        """ä¸´æ—¶é¡¹ç›®ç›®å½•"""
        temp_dir = tempfile.mkdtemp()
        project_dir = Path(temp_dir) / "test_project"
        project_dir.mkdir()
        
        # åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
        (project_dir / "output_video_music").mkdir()
        (project_dir / "uploader_json").mkdir()
        
        yield str(project_dir)
        
        shutil.rmtree(temp_dir)

    @pytest.fixture
    def mock_tweepy(mocker):
        """æ¨¡æ‹Ÿ tweepy åº“"""
        mock_client = mocker.MagicMock()
        mock_api = mocker.MagicMock()
        
        # æ¨¡æ‹ŸæˆåŠŸçš„APIå“åº”
        mock_client.create_tweet.return_value.data = {'id': '1234567890'}
        mock_api.media_upload.return_value.media_id_string = 'media_123'
        mock_api.verify_credentials.return_value.screen_name = 'test_user'
        
        mocker.patch('app.core.publisher.tweepy.Client', return_value=mock_client)
        mocker.patch('app.core.publisher.tweepy.API', return_value=mock_api)
        mocker.patch('app.core.publisher.tweepy.OAuth1UserHandler')
        
        return {'client': mock_client, 'api': mock_api}

    @pytest.fixture
    def mock_gemini(mocker):
        """æ¨¡æ‹Ÿ google-generativeai åº“"""
        mock_model = mocker.MagicMock()
        mock_model.generate_content.return_value.text = "Enhanced tweet content with AI"
        
        mocker.patch('app.core.content_generator.genai.configure')
        mocker.patch('app.core.content_generator.genai.GenerativeModel', return_value=mock_model)
        mocker.patch('app.core.content_generator.GEMINI_AVAILABLE', True)
        
        return mock_model

    @pytest.fixture
    def sample_metadata():
        """ç¤ºä¾‹å…ƒæ•°æ®"""
        return {
            "sample_video_01.mp4": {
                "title": "Test Video Title",
                "description": "This is a test video description for testing purposes.",
                "hashtags": ["#test", "#video", "#automation"],
                "keywords": ["test", "video", "automation"]
            }
        }

    @pytest.fixture
    def api_headers():
        """APIè¯·æ±‚å¤´"""
        return {"X-API-Key": "test-api-key"}
    ```

#### **ä¸‰ã€ è¯¦ç»†æµ‹è¯•æ–¹æ¡ˆ**

**A. å•å…ƒæµ‹è¯• (Unit Tests)**

*   **ç›®æ ‡**: éªŒè¯æœ€å°ä»£ç å•å…ƒçš„é€»è¾‘æ­£ç¡®æ€§ï¼Œå®Œå…¨éš”ç¦»å¤–éƒ¨ä¾èµ–ã€‚
*   **ä½ç½®**: `tests/unit/`

### 1. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯• (`tests/unit/core/`)

**`test_content_generator.py`**:
```python
def test_generate_tweet_from_json_directly(sample_metadata):
    """æµ‹è¯•ç›´æ¥ä»JSONç”Ÿæˆæ¨æ–‡"""
    generator = ContentGenerator(use_ai=False)
    
    # åˆ›å»ºä¸´æ—¶å…ƒæ•°æ®æ–‡ä»¶
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        json.dump(sample_metadata, f)
        metadata_path = f.name
    
    content, duration = generator.generate_tweet(
        metadata_path, "sample_video_01.mp4", "en"
    )
    
    assert "Test Video Title" in content
    assert "#test" in content
    assert len(content) <= 280
    assert duration > 0
    
    os.unlink(metadata_path)

def test_generate_tweet_with_ai(mock_gemini, sample_metadata):
    """æµ‹è¯•AIå¢å¼ºæ¨æ–‡ç”Ÿæˆ"""
    generator = ContentGenerator(use_ai=True, gemini_api_key="test_key")
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as f:
        json.dump(sample_metadata, f)
        metadata_path = f.name
    
    content, duration = generator.generate_tweet(
        metadata_path, "sample_video_01.mp4", "en"
    )
    
    assert content == "Enhanced tweet content with AI"
    mock_gemini.generate_content.assert_called_once()
    
    os.unlink(metadata_path)

def test_generate_tweet_missing_metadata():
    """æµ‹è¯•ç¼ºå¤±å…ƒæ•°æ®çš„å¤„ç†"""
    generator = ContentGenerator(use_ai=False)
    
    with pytest.raises(ValueError, match="æ— æ³•è¯»å–å…ƒæ•°æ®æ–‡ä»¶"):
        generator.generate_tweet("/nonexistent/path.json", "video.mp4", "en")

@pytest.mark.parametrize("language,expected_prefix", [
    ("en", "ğŸ¥ New Video:"),
    ("cn", "ğŸ¥ æ–°è§†é¢‘ï¼š"),
    ("ja", "ğŸ¥ æ–°ã—ã„å‹•ç”»ï¼š")
])
def test_content_type_prefix(language, expected_prefix):
    """æµ‹è¯•å¤šè¯­è¨€å‰ç¼€"""
    generator = ContentGenerator()
    prefix = generator._get_content_type_prefix("video", language)
    assert prefix == expected_prefix
```

**`test_publisher.py`**:
```python
def test_post_tweet_with_video_success(mock_tweepy):
    """æµ‹è¯•æˆåŠŸå‘å¸ƒè§†é¢‘æ¨æ–‡"""
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    
    # åˆ›å»ºä¸´æ—¶è§†é¢‘æ–‡ä»¶
    with tempfile.NamedTemporaryFile(suffix='.mp4', delete=False) as f:
        f.write(b"fake video content")
        video_path = f.name
    
    tweet_info, duration = publisher.post_tweet_with_video(
        "Test tweet content", video_path
    )
    
    assert tweet_info["tweet_id"] == "1234567890"
    assert "twitter.com" in tweet_info["tweet_url"]
    assert duration > 0
    
    mock_tweepy['api'].media_upload.assert_called_once()
    mock_tweepy['client'].create_tweet.assert_called_once()
    
    os.unlink(video_path)

def test_post_tweet_file_not_found():
    """æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨çš„å¤„ç†"""
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    
    with pytest.raises(FileNotFoundError):
        publisher.post_tweet_with_video("Test", "/nonexistent/video.mp4")

def test_post_tweet_api_error(mock_tweepy):
    """æµ‹è¯•APIé”™è¯¯å¤„ç†"""
    mock_tweepy['client'].create_tweet.side_effect = Exception("API Error")
    
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    
    with tempfile.NamedTemporaryFile(suffix='.mp4', delete=False) as f:
        f.write(b"fake video content")
        video_path = f.name
    
    with pytest.raises(Exception, match="API Error"):
        publisher.post_tweet_with_video("Test", video_path)
    
    os.unlink(video_path)
```

**`test_project_manager.py`**:
```python
def test_scan_and_create_tasks(db_session, temp_project_dir, sample_metadata):
    """æµ‹è¯•é¡¹ç›®æ‰«æå’Œä»»åŠ¡åˆ›å»º"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    video_dir = Path(temp_project_dir) / "output_video_music"
    json_dir = Path(temp_project_dir) / "uploader_json"
    
    # åˆ›å»ºæµ‹è¯•è§†é¢‘æ–‡ä»¶
    test_video = video_dir / "sample_video_01.mp4"
    test_video.write_bytes(b"fake video content")
    
    # åˆ›å»ºæµ‹è¯•å…ƒæ•°æ®æ–‡ä»¶
    metadata_file = json_dir / "en_prompt_results_batch.json"
    with open(metadata_file, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    # æ‰§è¡Œæ‰«æ
    manager = ProjectManager(db_session, str(Path(temp_project_dir).parent), user_id=1)
    new_tasks = manager.scan_and_create_tasks("test_project", "en")
    
    assert new_tasks == 1
    
    # éªŒè¯æ•°æ®åº“ä¸­çš„è®°å½•
    project = db_session.query(Project).filter_by(name="test_project").first()
    assert project is not None
    
    tasks = db_session.query(PublishingTask).filter_by(project_id=project.id).all()
    assert len(tasks) == 1
    assert tasks[0].status == "pending"

def test_scan_duplicate_tasks(db_session, temp_project_dir, sample_metadata):
    """æµ‹è¯•é‡å¤æ‰«æä¸åˆ›å»ºé‡å¤ä»»åŠ¡"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆåŒä¸Šï¼‰
    video_dir = Path(temp_project_dir) / "output_video_music"
    json_dir = Path(temp_project_dir) / "uploader_json"
    
    test_video = video_dir / "sample_video_01.mp4"
    test_video.write_bytes(b"fake video content")
    
    metadata_file = json_dir / "en_prompt_results_batch.json"
    with open(metadata_file, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    manager = ProjectManager(db_session, str(Path(temp_project_dir).parent), user_id=1)
    
    # ç¬¬ä¸€æ¬¡æ‰«æ
    new_tasks_1 = manager.scan_and_create_tasks("test_project", "en")
    assert new_tasks_1 == 1
    
    # ç¬¬äºŒæ¬¡æ‰«æ
    new_tasks_2 = manager.scan_and_create_tasks("test_project", "en")
    assert new_tasks_2 == 0  # ä¸åº”è¯¥åˆ›å»ºæ–°ä»»åŠ¡
```

**`test_task_scheduler.py`**:
```python
def test_get_next_pending_task(db_session, mock_tweepy, mock_gemini):
    """æµ‹è¯•è·å–ä¸‹ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡"""
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    project = Project(name="test_project", user_id=1)
    db_session.add(project)
    db_session.commit()
    
    task = PublishingTask(
        project_id=project.id,
        media_path="/test/video.mp4",
        metadata_path="/test/metadata.json",
        language="en",
        status="pending",
        scheduled_at=datetime.utcnow() - timedelta(minutes=1)
    )
    db_session.add(task)
    db_session.commit()
    
    # åˆ›å»ºè°ƒåº¦å™¨
    config = {'scheduler': {'interval_minutes_min': 15, 'interval_minutes_max': 30, 'max_retries': 3}}
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    generator = ContentGenerator()
    scheduler = TaskScheduler(db_session, publisher, generator, config)
    
    # æµ‹è¯•è·å–ä»»åŠ¡
    next_task = scheduler._get_next_pending_task()
    assert next_task is not None
    assert next_task.id == task.id
```

### 2. æ•°æ®åº“å±‚æµ‹è¯• (`tests/unit/database/`)

**`test_models.py`**:
```python
def test_user_model(db_session):
    """æµ‹è¯•ç”¨æˆ·æ¨¡å‹"""
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    assert user.id is not None
    assert user.username == "testuser"
    assert user.created_at is not None

def test_project_model(db_session):
    """æµ‹è¯•é¡¹ç›®æ¨¡å‹"""
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    project = Project(name="test_project", user_id=user.id, description="Test project")
    db_session.add(project)
    db_session.commit()
    
    assert project.id is not None
    assert project.user_id == user.id
    assert project.user.username == "testuser"

def test_publishing_task_content_data():
    """æµ‹è¯•å‘å¸ƒä»»åŠ¡çš„å†…å®¹æ•°æ®åºåˆ—åŒ–"""
    task = PublishingTask()
    
    test_data = {"title": "Test", "description": "Test description"}
    task.set_content_data(test_data)
    
    retrieved_data = task.get_content_data()
    assert retrieved_data == test_data
```

**`test_repository.py`**:
```python
def test_user_repository_create(db_session):
    """æµ‹è¯•ç”¨æˆ·ä»“åº“åˆ›å»ºåŠŸèƒ½"""
    repo = UserRepository(db_session)
    
    user_data = {"username": "testuser", "role": "editor"}
    user = repo.create(user_data)
    
    assert user.username == "testuser"
    assert user.role == "editor"
    assert user.id is not None

def test_project_repository_get_by_name_and_user(db_session):
    """æµ‹è¯•é¡¹ç›®ä»“åº“æŒ‰åç§°å’Œç”¨æˆ·æŸ¥è¯¢"""
    # åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    # åˆ›å»ºæµ‹è¯•é¡¹ç›®
    project = Project(name="test_project", user_id=user.id)
    db_session.add(project)
    db_session.commit()
    
    repo = ProjectRepository(db_session)
    found_project = repo.get_by_name_and_user("test_project", user.id)
    
    assert found_project is not None
    assert found_project.name == "test_project"
    assert found_project.user_id == user.id
```

### 3. APIå±‚æµ‹è¯• (`tests/unit/api/`)

**`test_dependencies.py`**:
```python
def test_api_key_auth_valid(test_config):
    """æµ‹è¯•æœ‰æ•ˆAPIå¯†é’¥è®¤è¯"""
    # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„APIå¯†é’¥è®¤è¯é€»è¾‘è¿›è¡Œæµ‹è¯•
    pass

def test_api_key_auth_invalid():
    """æµ‹è¯•æ— æ•ˆAPIå¯†é’¥è®¤è¯"""
    # æµ‹è¯•æ— æ•ˆå¯†é’¥çš„å¤„ç†
    pass

def test_pagination_params():
    """æµ‹è¯•åˆ†é¡µå‚æ•°è§£æ"""
    from api.dependencies import get_pagination_params
    
    # æ¨¡æ‹Ÿè¯·æ±‚å‚æ•°
    params = get_pagination_params(page=2, size=20)
    assert params["offset"] == 20
    assert params["limit"] == 20
```

**`test_middleware.py`**:
```python
def test_error_handling_middleware(test_client):
    """æµ‹è¯•é”™è¯¯å¤„ç†ä¸­é—´ä»¶"""
    # è§¦å‘ä¸€ä¸ªä¼šå¯¼è‡´500é”™è¯¯çš„è¯·æ±‚
    response = test_client.get("/api/v1/nonexistent-endpoint")
    
    # éªŒè¯é”™è¯¯å“åº”æ ¼å¼
    assert response.status_code == 404
    assert "error" in response.json()

def test_rate_limit_middleware(test_client):
    """æµ‹è¯•é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶"""
    # å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚
    responses = []
    for _ in range(10):
        response = test_client.get("/api/v1/dashboard/health")
        responses.append(response)
    
    # æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚è¢«é™åˆ¶
    status_codes = [r.status_code for r in responses]
    # æ ¹æ®å®é™…çš„é€Ÿç‡é™åˆ¶é…ç½®è¿›è¡Œæ–­è¨€
```

**B. é›†æˆæµ‹è¯• (Integration Tests)**

*   **ç›®æ ‡**: éªŒè¯æ¨¡å—é—´çš„äº¤äº’ï¼Œç‰¹åˆ«æ˜¯ä¸æ•°æ®åº“çš„äº¤äº’ã€‚
*   **ä½ç½®**: `tests/integration/`

### 1. æ•°æ®åº“é›†æˆæµ‹è¯• (`tests/integration/database/`)

**`test_database_operations.py`**:
```python
def test_complete_project_workflow(db_session):
    """æµ‹è¯•å®Œæ•´çš„é¡¹ç›®å·¥ä½œæµç¨‹"""
    # 1. åˆ›å»ºç”¨æˆ·
    user_repo = UserRepository(db_session)
    user = user_repo.create({"username": "testuser", "role": "admin"})
    
    # 2. åˆ›å»ºé¡¹ç›®
    project_repo = ProjectRepository(db_session)
    project = project_repo.create({
        "name": "test_project",
        "user_id": user.id,
        "description": "Test project"
    })
    
    # 3. åˆ›å»ºå†…å®¹æº
    content_source_repo = ContentSourceRepository(db_session)
    content_source = content_source_repo.create({
        "project_id": project.id,
        "file_path": "/test/video.mp4",
        "metadata_path": "/test/metadata.json",
        "file_type": "video",
        "language": "en"
    })
    
    # 4. åˆ›å»ºå‘å¸ƒä»»åŠ¡
    task_repo = PublishingTaskRepository(db_session)
    task = task_repo.create({
        "project_id": project.id,
        "content_source_id": content_source.id,
        "media_path": "/test/video.mp4",
        "metadata_path": "/test/metadata.json",
        "language": "en",
        "status": "pending"
    })
    
    # éªŒè¯å…³è”å…³ç³»
    assert task.project.name == "test_project"
    assert task.content_source.file_path == "/test/video.mp4"
    assert task.project.user.username == "testuser"
    
    # 5. æ›´æ–°ä»»åŠ¡çŠ¶æ€
    task_repo.update(task.id, {"status": "completed"})
    updated_task = task_repo.get_by_id(task.id)
    assert updated_task.status == "completed"

def test_database_constraints(db_session):
    """æµ‹è¯•æ•°æ®åº“çº¦æŸ"""
    user_repo = UserRepository(db_session)
    project_repo = ProjectRepository(db_session)
    
    # åˆ›å»ºç”¨æˆ·
    user = user_repo.create({"username": "testuser", "role": "admin"})
    
    # åˆ›å»ºé¡¹ç›®
    project_repo.create({
        "name": "test_project",
        "user_id": user.id
    })
    
    # å°è¯•åˆ›å»ºåŒåé¡¹ç›®ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    with pytest.raises(Exception):
        project_repo.create({
            "name": "test_project",
            "user_id": user.id
        })

def test_foreign_key_constraints(db_session):
    """æµ‹è¯•å¤–é”®çº¦æŸ"""
    task_repo = PublishingTaskRepository(db_session)
    
    # å°è¯•åˆ›å»ºå…³è”åˆ°ä¸å­˜åœ¨é¡¹ç›®çš„ä»»åŠ¡
    with pytest.raises(Exception):
        task_repo.create({
            "project_id": 99999,  # ä¸å­˜åœ¨çš„é¡¹ç›®ID
            "media_path": "/test/video.mp4",
            "metadata_path": "/test/metadata.json",
            "language": "en",
            "status": "pending"
        })
```

### 2. ä¸šåŠ¡æµç¨‹é›†æˆæµ‹è¯• (`tests/integration/workflows/`)

**`test_scheduler_flow.py`**:
```python
def test_complete_scheduling_workflow(db_session, mock_tweepy, mock_gemini, temp_project_dir, sample_metadata):
    """æµ‹è¯•å®Œæ•´çš„è°ƒåº¦å·¥ä½œæµç¨‹"""
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    project = Project(name="test_project", user_id=user.id)
    db_session.add(project)
    db_session.commit()
    
    # åˆ›å»ºä¸´æ—¶åª’ä½“æ–‡ä»¶
    video_path = Path(temp_project_dir) / "test_video.mp4"
    video_path.write_bytes(b"fake video content")
    
    metadata_path = Path(temp_project_dir) / "test_metadata.json"
    with open(metadata_path, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    # åˆ›å»ºå‘å¸ƒä»»åŠ¡
    task = PublishingTask(
        project_id=project.id,
        media_path=str(video_path),
        metadata_path=str(metadata_path),
        language="en",
        status="pending",
        scheduled_at=datetime.utcnow() - timedelta(minutes=1)
    )
    db_session.add(task)
    db_session.commit()
    
    # åˆ›å»ºè°ƒåº¦å™¨ç»„ä»¶
    config = {
        'scheduler': {
            'interval_minutes_min': 15,
            'interval_minutes_max': 30,
            'max_retries': 3
        }
    }
    
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    generator = ContentGenerator(use_ai=False)
    scheduler = TaskScheduler(db_session, publisher, generator, config)
    
    # æ‰§è¡Œè°ƒåº¦
    processed_count = scheduler.run_once()
    
    # éªŒè¯ç»“æœ
    assert processed_count == 1
    
    # æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    updated_task = db_session.query(PublishingTask).filter_by(id=task.id).first()
    assert updated_task.status == "completed"
    assert updated_task.tweet_id == "1234567890"
    
    # æ£€æŸ¥å‘å¸ƒæ—¥å¿—
    log = db_session.query(PublishingLog).filter_by(task_id=task.id).first()
    assert log is not None
    assert log.status == "success"
    
    # éªŒè¯APIè°ƒç”¨
    mock_tweepy['api'].media_upload.assert_called_once()
    mock_tweepy['client'].create_tweet.assert_called_once()

def test_scheduling_failure_retry(db_session, mock_tweepy, mock_gemini, temp_project_dir, sample_metadata):
    """æµ‹è¯•è°ƒåº¦å¤±è´¥é‡è¯•æœºåˆ¶"""
    # è®¾ç½®APIè°ƒç”¨å¤±è´¥
    mock_tweepy['client'].create_tweet.side_effect = Exception("API Error")
    
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    project = Project(name="test_project", user_id=user.id)
    db_session.add(project)
    db_session.commit()
    
    video_path = Path(temp_project_dir) / "test_video.mp4"
    video_path.write_bytes(b"fake video content")
    
    metadata_path = Path(temp_project_dir) / "test_metadata.json"
    with open(metadata_path, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    task = PublishingTask(
        project_id=project.id,
        media_path=str(video_path),
        metadata_path=str(metadata_path),
        language="en",
        status="pending",
        scheduled_at=datetime.utcnow() - timedelta(minutes=1),
        retry_count=0
    )
    db_session.add(task)
    db_session.commit()
    
    # åˆ›å»ºè°ƒåº¦å™¨
    config = {'scheduler': {'max_retries': 3}}
    publisher = TwitterPublisher("key", "secret", "token", "token_secret")
    generator = ContentGenerator(use_ai=False)
    scheduler = TaskScheduler(db_session, publisher, generator, config)
    
    # æ‰§è¡Œè°ƒåº¦ï¼ˆåº”è¯¥å¤±è´¥ï¼‰
    processed_count = scheduler.run_once()
    
    # éªŒè¯ç»“æœ
    assert processed_count == 1
    
    # æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    updated_task = db_session.query(PublishingTask).filter_by(id=task.id).first()
    assert updated_task.status == "failed"
    assert updated_task.retry_count == 1
    
    # æ£€æŸ¥é”™è¯¯æ—¥å¿—
    log = db_session.query(PublishingLog).filter_by(task_id=task.id).first()
    assert log is not None
    assert log.status == "error"
    assert "API Error" in log.error_message

def test_project_manager_integration(db_session, temp_project_dir, sample_metadata):
    """æµ‹è¯•é¡¹ç›®ç®¡ç†å™¨é›†æˆæµç¨‹"""
    # å‡†å¤‡æµ‹è¯•é¡¹ç›®ç»“æ„
    project_root = Path(temp_project_dir)
    video_dir = project_root / "output_video_music"
    json_dir = project_root / "uploader_json"
    
    video_dir.mkdir(parents=True)
    json_dir.mkdir(parents=True)
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    test_video = video_dir / "sample_video_01.mp4"
    test_video.write_bytes(b"fake video content")
    
    metadata_file = json_dir / "en_prompt_results_batch.json"
    with open(metadata_file, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    # åˆ›å»ºç”¨æˆ·
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    # æ‰§è¡Œé¡¹ç›®ç®¡ç†å™¨æ‰«æ
    manager = ProjectManager(db_session, str(project_root.parent), user_id=user.id)
    new_tasks = manager.scan_and_create_tasks("test_project", "en")
    
    assert new_tasks == 1
    
    # éªŒè¯æ•°æ®åº“è®°å½•
    project = db_session.query(Project).filter_by(name="test_project").first()
    assert project is not None
    assert project.user_id == user.id
    
    content_source = db_session.query(ContentSource).filter_by(project_id=project.id).first()
    assert content_source is not None
    assert content_source.file_type == "video"
    
    task = db_session.query(PublishingTask).filter_by(project_id=project.id).first()
    assert task is not None
    assert task.status == "pending"
    assert task.language == "en"
```

### 3. APIé›†æˆæµ‹è¯• (`tests/integration/api/`)

**`test_api_workflows.py`**:
```python
def test_project_management_api_flow(test_client, db_session):
    """æµ‹è¯•é¡¹ç›®ç®¡ç†APIå®Œæ•´æµç¨‹"""
    # 1. åˆ›å»ºé¡¹ç›®
    project_data = {
        "name": "test_project",
        "description": "Test project description",
        "language": "en"
    }
    
    response = test_client.post("/api/v1/projects", json=project_data)
    assert response.status_code == 201
    project_id = response.json()["id"]
    
    # 2. è·å–é¡¹ç›®åˆ—è¡¨
    response = test_client.get("/api/v1/projects")
    assert response.status_code == 200
    projects = response.json()["items"]
    assert len(projects) == 1
    assert projects[0]["name"] == "test_project"
    
    # 3. è·å–å•ä¸ªé¡¹ç›®
    response = test_client.get(f"/api/v1/projects/{project_id}")
    assert response.status_code == 200
    project = response.json()
    assert project["name"] == "test_project"
    
    # 4. æ›´æ–°é¡¹ç›®
    update_data = {"description": "Updated description"}
    response = test_client.put(f"/api/v1/projects/{project_id}", json=update_data)
    assert response.status_code == 200
    
    # 5. éªŒè¯æ›´æ–°
    response = test_client.get(f"/api/v1/projects/{project_id}")
    assert response.json()["description"] == "Updated description"
    
    # 6. åˆ é™¤é¡¹ç›®
    response = test_client.delete(f"/api/v1/projects/{project_id}")
    assert response.status_code == 204
    
    # 7. éªŒè¯åˆ é™¤
    response = test_client.get(f"/api/v1/projects/{project_id}")
    assert response.status_code == 404

def test_task_management_api_flow(test_client, db_session):
    """æµ‹è¯•ä»»åŠ¡ç®¡ç†APIå®Œæ•´æµç¨‹"""
    # å…ˆåˆ›å»ºé¡¹ç›®
    project_data = {"name": "test_project", "language": "en"}
    response = test_client.post("/api/v1/projects", json=project_data)
    project_id = response.json()["id"]
    
    # 1. æ‰«æé¡¹ç›®åˆ›å»ºä»»åŠ¡
    response = test_client.post(f"/api/v1/projects/{project_id}/scan")
    assert response.status_code == 200
    
    # 2. è·å–ä»»åŠ¡åˆ—è¡¨
    response = test_client.get("/api/v1/tasks")
    assert response.status_code == 200
    
    # 3. æ‰‹åŠ¨è§¦å‘ä»»åŠ¡æ‰§è¡Œ
    response = test_client.post("/api/v1/tasks/execute")
    assert response.status_code == 200
    
    # 4. è·å–ä»»åŠ¡ç»Ÿè®¡
    response = test_client.get("/api/v1/tasks/stats")
    assert response.status_code == 200
    stats = response.json()
    assert "total" in stats
    assert "pending" in stats
    assert "completed" in stats

def test_dashboard_api_integration(test_client, db_session):
    """æµ‹è¯•ä»ªè¡¨æ¿APIé›†æˆ"""
    # 1. å¥åº·æ£€æŸ¥
    response = test_client.get("/api/v1/dashboard/health")
    assert response.status_code == 200
    health = response.json()
    assert health["status"] == "healthy"
    
    # 2. ç³»ç»Ÿç»Ÿè®¡
    response = test_client.get("/api/v1/dashboard/stats")
    assert response.status_code == 200
    stats = response.json()
    assert "projects" in stats
    assert "tasks" in stats
    assert "users" in stats
    
    # 3. æœ€è¿‘æ´»åŠ¨
    response = test_client.get("/api/v1/dashboard/recent-activity")
    assert response.status_code == 200
    activity = response.json()
    assert "items" in activity
```

**C. ç«¯åˆ°ç«¯æµ‹è¯• (E2E Tests)**

*   **ç›®æ ‡**: æ¨¡æ‹Ÿç”¨æˆ·çœŸå®ä½¿ç”¨åœºæ™¯ï¼ŒéªŒè¯æ•´ä¸ªç³»ç»Ÿçš„å®Œæ•´æ€§ã€‚
*   **ä½ç½®**: `tests/e2e/`
*   **é‡è¦æç¤º**: è¿™äº›æµ‹è¯•æ ‡è®°ä¸º `@pytest.mark.e2e`ã€‚é»˜è®¤æƒ…å†µä¸‹å¯ä»¥é…ç½® `pytest` è·³è¿‡å®ƒä»¬ï¼Œåªåœ¨ä¸“é—¨çš„ E2E æµ‹è¯•é˜¶æ®µè¿è¡Œã€‚**å‡¡æ¶‰åŠçœŸå® API çš„æµ‹è¯•ï¼Œå¿…é¡»ä½¿ç”¨ä¸“ç”¨çš„ã€æ— å•†ä¸šä»·å€¼çš„æµ‹è¯• Twitter è´¦å·å’Œ API Keyã€‚**

### 1. CLIç«¯åˆ°ç«¯æµ‹è¯• (`tests/e2e/cli/`)

**`test_cli_flow.py`**:
```python
@pytest.mark.e2e
def test_complete_cli_workflow(runner, db_session, temp_project_dir, sample_metadata, mock_tweepy, mock_gemini):
    """æµ‹è¯•å®Œæ•´çš„CLIå·¥ä½œæµç¨‹"""
    # 1. å‡†å¤‡æµ‹è¯•é¡¹ç›®ç»“æ„
    project_root = Path(temp_project_dir)
    video_dir = project_root / "output_video_music"
    json_dir = project_root / "uploader_json"
    
    video_dir.mkdir(parents=True)
    json_dir.mkdir(parents=True)
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    test_video = video_dir / "sample_video_01.mp4"
    test_video.write_bytes(b"fake video content")
    
    metadata_file = json_dir / "en_prompt_results_batch.json"
    with open(metadata_file, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    # 2. æ‰§è¡Œé¡¹ç›®æ‰«æ
    result = runner.invoke(cli, [
        'scan',
        '--project-root', str(project_root.parent),
        '--project', 'test_project',
        '--language', 'en'
    ])
    
    assert result.exit_code == 0
    assert "æ‰«æå®Œæˆ" in result.output
    
    # éªŒè¯æ•°æ®åº“ä¸­çš„è®°å½•
    project = db_session.query(Project).filter_by(name="test_project").first()
    assert project is not None
    
    tasks = db_session.query(PublishingTask).filter_by(project_id=project.id).all()
    assert len(tasks) == 1
    assert tasks[0].status == "pending"
    
    # 3. æ‰§è¡Œå‘å¸ƒä»»åŠ¡
    result = runner.invoke(cli, [
        'publish',
        '--limit', '1',
        '--dry-run', 'false'
    ])
    
    assert result.exit_code == 0
    assert "å‘å¸ƒå®Œæˆ" in result.output
    
    # éªŒè¯ä»»åŠ¡çŠ¶æ€æ›´æ–°
    updated_task = db_session.query(PublishingTask).filter_by(id=tasks[0].id).first()
    assert updated_task.status == "completed"
    
    # éªŒè¯å‘å¸ƒæ—¥å¿—
    log = db_session.query(PublishingLog).filter_by(task_id=tasks[0].id).first()
    assert log is not None
    assert log.status == "success"

@pytest.mark.e2e
def test_database_maintenance_commands(runner, db_session):
    """æµ‹è¯•æ•°æ®åº“ç»´æŠ¤å‘½ä»¤"""
    # åˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    project = Project(name="old_project", user_id=user.id)
    db_session.add(project)
    db_session.commit()
    
    # åˆ›å»ºä¸€ä¸ªæ—§çš„å‘å¸ƒæ—¥å¿—
    old_log = PublishingLog(
        task_id=1,
        status="success",
        created_at=datetime.utcnow() - timedelta(days=31)
    )
    db_session.add(old_log)
    db_session.commit()
    
    # 1. æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡
    result = runner.invoke(cli, ['db:stats'])
    assert result.exit_code == 0
    assert "é¡¹ç›®æ•°é‡" in result.output
    
    # 2. æµ‹è¯•æ•°æ®æ¸…ç†
    result = runner.invoke(cli, ['db:purge', '--days', '30', '--confirm'])
    assert result.exit_code == 0
    assert "æ¸…ç†å®Œæˆ" in result.output
    
    # éªŒè¯æ—§æ•°æ®è¢«åˆ é™¤
    remaining_logs = db_session.query(PublishingLog).filter(
        PublishingLog.created_at < datetime.utcnow() - timedelta(days=30)
    ).count()
    assert remaining_logs == 0
    
    # 3. æµ‹è¯•æ•°æ®åº“å¥åº·æ£€æŸ¥
    result = runner.invoke(cli, ['db:health'])
    assert result.exit_code == 0
    assert "æ•°æ®åº“è¿æ¥æ­£å¸¸" in result.output

@pytest.mark.e2e
def test_project_management_cli(runner, db_session, temp_project_dir):
    """æµ‹è¯•é¡¹ç›®ç®¡ç†CLIå‘½ä»¤"""
    # 1. åˆ—å‡ºé¡¹ç›®ï¼ˆåº”è¯¥ä¸ºç©ºï¼‰
    result = runner.invoke(cli, ['project:list'])
    assert result.exit_code == 0
    assert "æš‚æ— é¡¹ç›®" in result.output
    
    # 2. åˆ›å»ºé¡¹ç›®
    result = runner.invoke(cli, [
        'project:create',
        '--name', 'test_project',
        '--description', 'Test project description',
        '--language', 'en'
    ])
    assert result.exit_code == 0
    assert "é¡¹ç›®åˆ›å»ºæˆåŠŸ" in result.output
    
    # 3. åˆ—å‡ºé¡¹ç›®ï¼ˆåº”è¯¥æœ‰ä¸€ä¸ªï¼‰
    result = runner.invoke(cli, ['project:list'])
    assert result.exit_code == 0
    assert "test_project" in result.output
    
    # 4. è·å–é¡¹ç›®è¯¦æƒ…
    result = runner.invoke(cli, ['project:info', '--name', 'test_project'])
    assert result.exit_code == 0
    assert "test_project" in result.output
    assert "Test project description" in result.output
```

### 2. APIç«¯åˆ°ç«¯æµ‹è¯• (`tests/e2e/api/`)

**`test_api_e2e.py`**:
```python
@pytest.mark.e2e
def test_complete_api_workflow(test_client, db_session, temp_project_dir, sample_metadata):
    """æµ‹è¯•å®Œæ•´çš„APIå·¥ä½œæµç¨‹"""
    # 1. åˆ›å»ºç”¨æˆ·å’ŒAPIå¯†é’¥
    user = User(username="testuser", role="admin")
    db_session.add(user)
    db_session.commit()
    
    api_key = ApiKey(
        user_id=user.id,
        key_hash="test_key_hash",
        name="Test API Key"
    )
    db_session.add(api_key)
    db_session.commit()
    
    # è®¾ç½®è®¤è¯å¤´
    headers = {"X-API-Key": "test_key"}
    
    # 2. åˆ›å»ºé¡¹ç›®
    project_data = {
        "name": "api_test_project",
        "description": "API test project",
        "language": "en"
    }
    
    response = test_client.post("/api/v1/projects", json=project_data, headers=headers)
    assert response.status_code == 201
    project_id = response.json()["id"]
    
    # 3. å‡†å¤‡é¡¹ç›®æ–‡ä»¶
    project_root = Path(temp_project_dir)
    video_dir = project_root / "output_video_music"
    json_dir = project_root / "uploader_json"
    
    video_dir.mkdir(parents=True)
    json_dir.mkdir(parents=True)
    
    test_video = video_dir / "sample_video_01.mp4"
    test_video.write_bytes(b"fake video content")
    
    metadata_file = json_dir / "en_prompt_results_batch.json"
    with open(metadata_file, 'w', encoding='utf-8') as f:
        json.dump(sample_metadata, f)
    
    # 4. æ‰«æé¡¹ç›®
    response = test_client.post(
        f"/api/v1/projects/{project_id}/scan",
        json={"project_root": str(project_root.parent)},
        headers=headers
    )
    assert response.status_code == 200
    scan_result = response.json()
    assert scan_result["new_tasks"] == 1
    
    # 5. è·å–ä»»åŠ¡åˆ—è¡¨
    response = test_client.get("/api/v1/tasks", headers=headers)
    assert response.status_code == 200
    tasks = response.json()["items"]
    assert len(tasks) == 1
    
    # 6. æ‰§è¡Œä»»åŠ¡
    response = test_client.post("/api/v1/tasks/execute", headers=headers)
    assert response.status_code == 200
    
    # 7. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    task_id = tasks[0]["id"]
    response = test_client.get(f"/api/v1/tasks/{task_id}", headers=headers)
    assert response.status_code == 200
    task = response.json()
    assert task["status"] in ["completed", "processing"]
    
    # 8. è·å–é¡¹ç›®ç»Ÿè®¡
    response = test_client.get(f"/api/v1/projects/{project_id}/stats", headers=headers)
    assert response.status_code == 200
    stats = response.json()
    assert stats["total_tasks"] == 1

@pytest.mark.e2e
def test_api_error_handling(test_client):
    """æµ‹è¯•APIé”™è¯¯å¤„ç†"""
    # 1. æœªè®¤è¯è¯·æ±‚
    response = test_client.get("/api/v1/projects")
    assert response.status_code == 401
    
    # 2. æ— æ•ˆAPIå¯†é’¥
    headers = {"X-API-Key": "invalid_key"}
    response = test_client.get("/api/v1/projects", headers=headers)
    assert response.status_code == 401
    
    # 3. ä¸å­˜åœ¨çš„èµ„æº
    headers = {"X-API-Key": "test_key"}
    response = test_client.get("/api/v1/projects/99999", headers=headers)
    assert response.status_code == 404
    
    # 4. æ— æ•ˆè¯·æ±‚æ•°æ®
    response = test_client.post(
        "/api/v1/projects",
        json={"invalid_field": "value"},
        headers=headers
    )
    assert response.status_code == 422
```

### 3. çœŸå®APIæµ‹è¯• (`tests/e2e/real_api/`)

**`test_real_twitter_api.py`**:
```python
@pytest.mark.e2e_real_api
@pytest.mark.skipif(
    not os.getenv("TWITTER_TEST_API_KEY"),
    reason="éœ€è¦çœŸå®çš„Twitteræµ‹è¯•APIå¯†é’¥"
)
def test_real_twitter_publishing(db_session, temp_project_dir):
    """æµ‹è¯•çœŸå®Twitter APIå‘å¸ƒï¼ˆéœ€è¦æµ‹è¯•è´¦å·ï¼‰"""
    # è­¦å‘Šï¼šæ­¤æµ‹è¯•ä½¿ç”¨çœŸå®APIï¼Œä»…åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œ
    
    # 1. é…ç½®çœŸå®APIå¯†é’¥
    api_key = os.getenv("TWITTER_TEST_API_KEY")
    api_secret = os.getenv("TWITTER_TEST_API_SECRET")
    access_token = os.getenv("TWITTER_TEST_ACCESS_TOKEN")
    access_token_secret = os.getenv("TWITTER_TEST_ACCESS_TOKEN_SECRET")
    
    # 2. åˆ›å»ºæå°çš„æµ‹è¯•åª’ä½“æ–‡ä»¶
    test_video_path = Path(temp_project_dir) / "test_video.mp4"
    # åˆ›å»ºä¸€ä¸ªæå°çš„æµ‹è¯•è§†é¢‘ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥æ˜¯æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶ï¼‰
    test_video_path.write_bytes(b"fake minimal video content")
    
    # 3. åˆ›å»ºæµ‹è¯•æ¨æ–‡å†…å®¹
    test_content = f"ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•æ¨æ–‡ - {datetime.now().strftime('%Y%m%d_%H%M%S')} #æµ‹è¯• #è‡ªåŠ¨åŒ–"
    
    # 4. æ‰§è¡Œå‘å¸ƒ
    publisher = TwitterPublisher(api_key, api_secret, access_token, access_token_secret)
    
    try:
        # å‘å¸ƒæ¨æ–‡
        tweet_info, duration = publisher.post_tweet_with_video(
            test_content, str(test_video_path)
        )
        
        # éªŒè¯å‘å¸ƒæˆåŠŸ
        assert "tweet_id" in tweet_info
        assert "tweet_url" in tweet_info
        assert duration > 0
        
        tweet_id = tweet_info["tweet_id"]
        
        # è®°å½•å‘å¸ƒæ—¥å¿—
        log = PublishingLog(
            task_id=0,  # æµ‹è¯•ä»»åŠ¡
            status="success",
            tweet_id=tweet_id,
            tweet_url=tweet_info["tweet_url"],
            execution_time=duration
        )
        db_session.add(log)
        db_session.commit()
        
        print(f"âœ… æµ‹è¯•æ¨æ–‡å‘å¸ƒæˆåŠŸ: {tweet_info['tweet_url']}")
        
    except Exception as e:
        pytest.fail(f"çœŸå®APIæµ‹è¯•å¤±è´¥: {str(e)}")
    
    finally:
        # 5. æ¸…ç†ï¼šåˆ é™¤æµ‹è¯•æ¨æ–‡
        try:
            if 'tweet_id' in locals():
                # æ³¨æ„ï¼šTwitter API v2 åˆ é™¤æ¨æ–‡éœ€è¦ç‰¹æ®Šæƒé™
                # åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†æˆ–ä½¿ç”¨æµ‹è¯•è´¦å·
                print(f"âš ï¸  è¯·æ‰‹åŠ¨åˆ é™¤æµ‹è¯•æ¨æ–‡: {tweet_id}")
        except Exception as cleanup_error:
            print(f"âš ï¸  æ¸…ç†æµ‹è¯•æ¨æ–‡å¤±è´¥: {cleanup_error}")

@pytest.mark.e2e_real_api
def test_twitter_api_error_handling():
    """æµ‹è¯•Twitter APIé”™è¯¯å¤„ç†"""
    # ä½¿ç”¨æ— æ•ˆçš„APIå¯†é’¥æµ‹è¯•é”™è¯¯å¤„ç†
    publisher = TwitterPublisher("invalid", "invalid", "invalid", "invalid")
    
    with pytest.raises(Exception):
        publisher.verify_credentials()
```

#### **å››ã€ æµ‹è¯•æ‰§è¡Œä¸æŒç»­é›†æˆ**

*   **æœ¬åœ°æ‰§è¡Œ**:
    *   è¿è¡Œæ‰€æœ‰å¿«é€Ÿæµ‹è¯•: `pytest`
    *   è¿è¡ŒåŒ…æ‹¬æ…¢é€Ÿçš„é›†æˆæµ‹è¯•: `pytest --runslow`
    *   ä»…è¿è¡Œ E2E æµ‹è¯•: `pytest -m e2e`
*   **CI/CD é›†æˆ (GitHub Actions)**:
    *   åœ¨ CI å·¥ä½œæµä¸­ï¼Œæ‰§è¡Œ `pytest` å‘½ä»¤ã€‚è¿™ä¼šè¿è¡Œæ‰€æœ‰å•å…ƒå’Œé›†æˆæµ‹è¯•ã€‚
    *   å¯ä»¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ã€éœ€è¦æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) æˆ–å®šæ—¶è§¦å‘çš„ E2E æµ‹è¯•å·¥ä½œæµï¼Œè¯¥å·¥ä½œæµä¼šè®¾ç½®å¥½çœŸå®çš„æµ‹è¯• API å¯†é’¥ï¼ˆé€šè¿‡ GitHub Secretsï¼‰ï¼Œç„¶åæ‰§è¡Œ `pytest -m e2e`ã€‚

è¿™ä¸ªå…¨é¢çš„æµ‹è¯•æ–¹æ¡ˆç¡®ä¿äº†ä»æœ€å°çš„é€»è¾‘å•å…ƒåˆ°æ•´ä¸ªç³»ç»Ÿçš„ç«¯åˆ°ç«¯æµç¨‹éƒ½å¾—åˆ°äº†å……åˆ†çš„éªŒè¯ï¼ŒåŒæ—¶é€šè¿‡åˆ†å±‚å’Œç‹¬ç«‹çš„è®¾è®¡ï¼Œä¿æŒäº†æµ‹è¯•çš„é«˜æ•ˆæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚