# Twitter自动发布系统 - 架构整理文档

## 1. 系统架构概览

### 1.1 端口配置
- **8080端口**: 后端API服务 + 前端静态文件服务（统一服务）
- **没有其他端口**: 当前系统只使用一个端口

### 1.2 架构模式
```
浏览器 → http://localhost:8080 → FastAPI服务器 (API: 8050)
                                    ├── 静态文件服务 (前端)
                                    └── API路由 (/api/*)
```

## 2. 前端架构

### 2.1 文件结构
```
frontend/
├── index.html          # 主页面
└── js/
    ├── api.js          # API客户端
    ├── app.js          # 主应用逻辑
    └── components/
        ├── dashboard.js    # 仪表板组件
        ├── tasks.js       # 任务管理组件
        └── projects.js    # 项目管理组件
```

### 2.2 前端技术栈
- **框架**: 原生JavaScript + Alpine.js
- **样式**: Tailwind CSS
- **API通信**: Fetch API
- **认证**: API Key (X-API-Key header)

### 2.3 API客户端配置
```javascript
class APIClient {
    constructor() {
        this.baseURL = '/api';  // 相对路径，同域请求
        this.apiKey = 'dev-api-key-12345';  // 开发环境密钥
    }
}
```

## 3. 后端架构

### 3.1 文件结构
```
api/
├── main.py             # FastAPI主应用
├── dependencies.py     # 依赖注入
├── middleware.py       # 中间件
├── schemas.py          # 数据模型
└── routers/
    ├── auth.py         # 认证路由
    ├── dashboard.py    # 仪表板路由
    ├── tasks.py        # 任务管理路由
    └── projects.py     # 项目管理路由
```

### 3.2 后端技术栈
- **框架**: FastAPI
- **数据库**: SQLite + SQLAlchemy ORM
- **认证**: API Key认证
- **文档**: 自动生成 OpenAPI/Swagger

### 3.3 API路由结构
```
/api/
├── /auth/*             # 认证相关
├── /dashboard/*        # 仪表板数据
├── /tasks/*           # 任务管理
└── /projects/*        # 项目管理
```

## 4. 数据库架构

### 4.1 数据库配置
- **类型**: SQLite
- **位置**: `/data/twitter_publisher.db`
- **管理**: DatabaseManager类

### 4.2 数据表结构
```sql
-- 用户表
users (
    id, username, email, role, api_key, created_at, updated_at
)

-- 项目表
projects (
    id, user_id, name, description, config, status, created_at, updated_at
)

-- 内容源表
content_sources (
    id, project_id, name, type, config, status, created_at, updated_at
)

-- 发布任务表
publishing_tasks (
    id, user_id, project_id, content_source_id, title, content, 
    media_urls, scheduled_time, status, created_at, updated_at
)

-- 发布日志表
publishing_logs (
    id, task_id, user_id, status, message, published_at, created_at
)

-- 分析数据表
analytics_hourly (
    id, user_id, project_id, hour, published_count, success_count, 
    error_count, created_at
)

-- API密钥表
api_keys (
    id, user_id, key_name, api_key, permissions, status, created_at
)
```

### 4.3 当前数据状态
```
用户数量: 2 (testuser, admin)
项目数量: 1
内容源数量: 1
任务数量: 0
日志数量: 0
分析数据: 0
```

## 5. API实现详情

### 5.1 认证机制
```python
# API密钥认证
async def api_key_auth(x_api_key: str = Header(..., alias="X-API-Key")):
    # 验证密钥: dev-api-key-12345 (开发环境)
    # 返回用户ID: 1 (默认用户)
```

### 5.2 主要API端点

#### 仪表板API
```
GET /api/dashboard/stats        # 获取统计信息
GET /api/dashboard/health       # 系统健康状态
GET /api/dashboard/recent-activity  # 最近活动
GET /api/dashboard/quick-stats  # 快速统计
```

#### 任务管理API
```
GET    /api/tasks              # 获取任务列表
POST   /api/tasks              # 创建任务
GET    /api/tasks/{id}         # 获取任务详情
PUT    /api/tasks/{id}         # 更新任务
DELETE /api/tasks/{id}         # 删除任务
POST   /api/tasks/{id}/execute # 执行任务
POST   /api/tasks/{id}/cancel  # 取消任务
```

#### 项目管理API
```
GET    /api/projects           # 获取项目列表
POST   /api/projects           # 创建项目
GET    /api/projects/{id}      # 获取项目详情
PUT    /api/projects/{id}      # 更新项目
DELETE /api/projects/{id}      # 删除项目
```

## 6. 核心业务逻辑

### 6.1 应用核心模块
```
app/
├── core/
│   ├── content_generator.py   # 内容生成器
│   ├── project_manager.py     # 项目管理器
│   ├── publisher.py           # 发布器
│   └── task_scheduler.py      # 任务调度器
├── database/
│   ├── database.py            # 数据库管理
│   ├── models.py              # 数据模型
│   └── repository.py          # 数据仓库
└── utils/
    ├── config.py              # 配置管理
    ├── logger.py              # 日志管理
    └── file_handler.py        # 文件处理
```

### 6.2 数据流程
```
1. 用户通过前端创建项目和内容源
2. 系统根据内容源生成发布任务
3. 任务调度器按时间执行任务
4. 发布器将内容发布到Twitter
5. 记录发布日志和分析数据
6. 前端展示统计信息和状态
```

## 7. 部署和运行

### 7.1 启动命令
```bash
# 启动后端API服务（包含前端）
python -m uvicorn api.main:app --host 0.0.0.0 --port 8050 --reload

# 访问地址
前端界面: http://localhost:8080
API文档: http://localhost:8050/api/docs
```

### 7.2 环境配置
```bash
# 安装依赖
pip install -r requirements.txt

# 环境变量
API_API_KEY=dev-api-key-12345
API_DEBUG=true
```

## 8. 当前问题和解决方案

### 8.1 已解决问题
- ✅ 静态文件路径错误 → 修复了API主文件中的路径配置
- ✅ API密钥不匹配 → 统一使用 `dev-api-key-12345`

### 8.2 待优化项目
- 🔄 数据库中缺少测试数据 → 需要创建示例项目和任务
- 🔄 前端错误处理 → 需要改进API调用失败的处理
- 🔄 认证机制 → 可以考虑JWT或OAuth2
- 🔄 性能优化 → 数据库查询优化和缓存

## 9. 开发建议

### 9.1 代码质量
- 添加更多单元测试和集成测试
- 实现API响应缓存
- 添加数据验证和错误处理

### 9.2 功能增强
- 实现实时通知功能
- 添加数据导出功能
- 支持多平台发布（不仅限于Twitter）

### 9.3 安全性
- 实现更安全的认证机制
- 添加API访问频率限制
- 敏感数据加密存储

---

**总结**: 当前系统采用单端口架构，后端FastAPI同时提供API服务和静态文件服务，前端通过相对路径调用API，使用API密钥进行认证。系统结构清晰，但需要添加更多测试数据和改进错误处理。