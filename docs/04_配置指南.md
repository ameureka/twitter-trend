# 配置指南

## 配置概述

本系统采用分层配置管理，支持多环境部署和动态配置更新。配置文件采用YAML格式，具有良好的可读性和可维护性。

## 核心配置原则

### 1. 配置优于代码 (Configuration over Code)
- 所有可变参数通过配置文件管理
- 避免硬编码，提高系统灵活性
- 支持运行时配置热重载

### 2. 环境隔离
- 开发、测试、生产环境配置分离
- 敏感信息通过环境变量管理
- 配置文件版本控制和审计

### 3. 安全性
- 敏感信息加密存储
- 配置文件权限控制
- 密钥轮换和管理

## 配置文件结构

### 主配置文件 (`config/config.yaml`)

```yaml
# 系统版本和环境
version: "2.0.0"
environment: "production"  # development, testing, production

# 应用基础配置
app:
  name: "Twitter Auto Publisher"
  debug: false
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  timezone: "Asia/Shanghai"
  
# 数据库配置
database:
  type: "sqlite"  # sqlite, mysql, postgresql
  path: "data/twitter_publisher.db"
  backup_enabled: true
  backup_interval_hours: 24
  cleanup_days: 30
  
# Twitter API配置
twitter:
  api_version: "v2"
  rate_limit:
    tweets_per_hour: 50
    requests_per_minute: 300
  retry:
    max_attempts: 3
    backoff_factor: 2
    
# Gemini AI配置
gemini:
  model: "gemini-pro"
  temperature: 0.7
  max_tokens: 1000
  timeout_seconds: 30
  
# 调度配置
scheduling:
  enabled: true
  interval_hours: 24
  batch_size: 5
  max_concurrent_tasks: 3
  start_time: "09:00"
  end_time: "18:00"
  
# 性能监控
performance:
  monitoring_enabled: true
  metrics_retention_days: 30
  alert_thresholds:
    cpu_percent: 80
    memory_percent: 85
    disk_percent: 90
    error_rate: 5
    
# 安全配置
security:
  api_key_required: true
  rate_limiting: true
  encryption_enabled: false
  session_timeout_minutes: 60
  
# 日志配置
logging:
  level: "INFO"
  format: "detailed"  # simple, detailed, json
  file_enabled: true
  file_path: "logs/app.log"
  max_file_size_mb: 10
  backup_count: 5
  
# 通知配置
notifications:
  enabled: true
  channels:
    email:
      enabled: false
      smtp_server: ""
      smtp_port: 587
    webhook:
      enabled: true
      url: ""
      timeout_seconds: 10
```

### 环境变量配置 (`.env`)

```bash
# 应用环境
APP_ENV=production
APP_DEBUG=false

# Twitter API密钥
TWITTER_API_KEY=your_api_key_here
TWITTER_API_SECRET=your_api_secret_here
TWITTER_ACCESS_TOKEN=your_access_token_here
TWITTER_ACCESS_TOKEN_SECRET=your_access_token_secret_here
TWITTER_BEARER_TOKEN=your_bearer_token_here

# Gemini AI密钥
GEMINI_API_KEY=your_gemini_api_key_here

# 数据库配置
DATABASE_URL=sqlite:///data/twitter_publisher.db

# API认证
API_SECRET_KEY=your_secret_key_here
API_ACCESS_TOKEN=your_access_token_here

# 通知配置
EMAIL_SMTP_SERVER=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_app_password

WEBHOOK_URL=https://your-webhook-url.com/notify

# 安全配置
ENCRYPTION_KEY=your_encryption_key_here
JWT_SECRET_KEY=your_jwt_secret_here
```

## 配置管理

### 1. 配置加载顺序

系统按以下优先级加载配置：

1. **命令行参数** (最高优先级)
2. **环境变量**
3. **配置文件**
4. **默认值** (最低优先级)

### 2. 配置验证

系统启动时会自动验证配置的完整性和正确性：

```python
# 配置验证示例
from app.utils.config_validator import ConfigValidator

validator = ConfigValidator()
result = validator.validate_config()

if not result['valid']:
    print(f"配置验证失败: {result['errors']}")
    exit(1)
```

### 3. 配置热重载

支持运行时动态更新配置，无需重启服务：

```bash
# 重载配置
python -m app.cli config reload

# 验证配置
python -m app.cli config validate

# 查看当前配置
python -m app.cli config show
```

## 环境配置

### 开发环境 (`config/development.yaml`)

```yaml
environment: "development"

app:
  debug: true
  log_level: "DEBUG"
  
database:
  path: "data/dev_twitter_publisher.db"
  backup_enabled: false
  
scheduling:
  interval_hours: 1  # 开发环境更频繁的调度
  
performance:
  monitoring_enabled: false
  
security:
  api_key_required: false  # 开发环境可选
  
logging:
  level: "DEBUG"
  format: "detailed"
```

### 测试环境 (`config/testing.yaml`)

```yaml
environment: "testing"

app:
  debug: false
  log_level: "WARNING"
  
database:
  path: ":memory:"  # 内存数据库
  backup_enabled: false
  
twitter:
  # 使用模拟API
  mock_enabled: true
  
gemini:
  # 使用模拟AI
  mock_enabled: true
  
scheduling:
  enabled: false  # 测试环境禁用调度
  
notifications:
  enabled: false  # 测试环境禁用通知
```

### 生产环境 (`config/production.yaml`)

```yaml
environment: "production"

app:
  debug: false
  log_level: "INFO"
  
database:
  backup_enabled: true
  backup_interval_hours: 6  # 生产环境更频繁备份
  
performance:
  monitoring_enabled: true
  alert_thresholds:
    cpu_percent: 70  # 生产环境更严格的阈值
    memory_percent: 75
    
security:
  api_key_required: true
  rate_limiting: true
  encryption_enabled: true
  
logging:
  level: "INFO"
  format: "json"  # 生产环境使用JSON格式便于分析
```

## 配置最佳实践

### 1. 敏感信息管理

**DO ✅**:
- 使用环境变量存储API密钥
- 启用配置文件加密
- 定期轮换密钥
- 限制配置文件访问权限

```bash
# 设置文件权限
chmod 600 .env
chmod 644 config/*.yaml
```

**DON'T ❌**:
- 在代码中硬编码密钥
- 将密钥提交到版本控制
- 在日志中输出敏感信息
- 使用弱密钥或默认密钥

### 2. 配置文件组织

```
config/
├── config.yaml          # 主配置文件
├── development.yaml     # 开发环境配置
├── testing.yaml         # 测试环境配置
├── production.yaml      # 生产环境配置
├── logging.yaml         # 日志配置
└── monitoring.yaml      # 监控配置
```

### 3. 配置验证规则

```python
# 配置验证规则示例
CONFIG_SCHEMA = {
    "app": {
        "name": {"type": "string", "required": True},
        "debug": {"type": "boolean", "default": False},
        "log_level": {
            "type": "string", 
            "allowed": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"]
        }
    },
    "database": {
        "type": {"type": "string", "allowed": ["sqlite", "mysql", "postgresql"]},
        "path": {"type": "string", "required": True}
    },
    "twitter": {
        "rate_limit": {
            "tweets_per_hour": {"type": "integer", "min": 1, "max": 100},
            "requests_per_minute": {"type": "integer", "min": 1, "max": 500}
        }
    }
}
```

## 配置工具

### 1. 配置管理CLI

```bash
# 查看配置
python -m app.cli config show [--section=app]

# 验证配置
python -m app.cli config validate [--env=production]

# 重载配置
python -m app.cli config reload

# 生成配置模板
python -m app.cli config template [--env=development]

# 加密敏感配置
python -m app.cli config encrypt --key=your_key

# 解密配置
python -m app.cli config decrypt --key=your_key
```

### 2. 配置监控

```bash
# 监控配置文件变化
python -m app.cli config watch

# 配置变更历史
python -m app.cli config history

# 配置差异比较
python -m app.cli config diff --env1=development --env2=production
```

## 故障排除

### 常见配置问题

#### 1. 配置文件格式错误

**错误信息**:
```
YAML parsing error: mapping values are not allowed here
```

**解决方案**:
- 检查YAML语法，确保正确的缩进
- 使用YAML验证工具检查格式
- 注意冒号后的空格

#### 2. 环境变量未设置

**错误信息**:
```
Configuration error: TWITTER_API_KEY is required but not set
```

**解决方案**:
```bash
# 检查环境变量
echo $TWITTER_API_KEY

# 设置环境变量
export TWITTER_API_KEY=your_api_key

# 或在.env文件中设置
echo "TWITTER_API_KEY=your_api_key" >> .env
```

#### 3. 配置权限问题

**错误信息**:
```
Permission denied: config/config.yaml
```

**解决方案**:
```bash
# 检查文件权限
ls -la config/

# 设置正确权限
chmod 644 config/config.yaml
chown $USER:$USER config/config.yaml
```

#### 4. 配置值类型错误

**错误信息**:
```
Validation error: scheduling.interval_hours must be an integer
```

**解决方案**:
- 检查配置值的数据类型
- 确保数值不使用引号
- 布尔值使用true/false而非True/False

### 配置调试

```bash
# 启用配置调试模式
export CONFIG_DEBUG=true
python -m app.cli config validate --verbose

# 查看配置加载过程
python -m app.cli config trace

# 导出当前有效配置
python -m app.cli config export --format=yaml
```

## 配置迁移

### 版本升级配置迁移

```python
# 配置迁移脚本示例
from app.utils.config_migrator import ConfigMigrator

migrator = ConfigMigrator()

# 从v1.0迁移到v2.0
result = migrator.migrate(
    from_version="1.0",
    to_version="2.0",
    config_path="config/config.yaml"
)

if result['success']:
    print(f"配置迁移成功: {result['changes']}")
else:
    print(f"配置迁移失败: {result['errors']}")
```

### 配置备份和恢复

```bash
# 备份当前配置
python -m app.cli config backup --name=pre_upgrade_backup

# 列出配置备份
python -m app.cli config backup list

# 恢复配置
python -m app.cli config restore --name=pre_upgrade_backup
```

---

**下一步**: 查看 [开发指南](05_开发指南.md) 了解开发环境搭建和代码规范。