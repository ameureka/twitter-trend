# 故障排除指南

## 故障排除概述

本指南提供了Twitter自动发布系统常见问题的诊断和解决方法，帮助用户快速定位和解决问题。

## 诊断工具

### 1. 系统健康检查

```bash
# 基础健康检查
python -m app.cli health

# 详细健康检查
python -m app.cli health --verbose

# 检查特定组件
python -m app.cli health --component=database
python -m app.cli health --component=twitter
python -m app.cli health --component=scheduler
```

### 2. 系统验证

```bash
# 完整系统验证
python -m app.cli validate

# 验证配置
python -m app.cli validate --config-only

# 验证依赖
python -m app.cli validate --dependencies

# 验证权限
python -m app.cli validate --permissions
```

### 3. 性能分析

```bash
# 查看性能指标
python -m app.cli performance

# 生成性能报告
python -m app.cli performance --report

# 实时监控
python -m app.cli performance --monitor
```

### 4. 日志分析

```bash
# 查看最新日志
python -m app.cli logs

# 查看错误日志
python -m app.cli logs --level=error

# 查看特定时间范围的日志
python -m app.cli logs --since="2024-01-01 00:00:00" --until="2024-01-02 00:00:00"

# 实时日志监控
python -m app.cli logs --follow
```

## 常见问题分类

### 1. 认证和授权问题

#### Twitter API认证失败

**症状**:
- 错误信息: "Unauthorized: Authentication credentials were missing or incorrect"
- API调用返回401状态码
- 无法发布推文

**可能原因**:
1. API密钥配置错误
2. 密钥已过期或被撤销
3. 权限不足
4. 环境变量未正确设置

**解决方案**:

```bash
# 1. 检查环境变量
echo $TWITTER_API_KEY
echo $TWITTER_API_SECRET
echo $TWITTER_ACCESS_TOKEN
echo $TWITTER_ACCESS_TOKEN_SECRET
echo $TWITTER_BEARER_TOKEN

# 2. 验证API密钥
python -c "
from app.services.twitter_service import TwitterService
service = TwitterService()
result = service.verify_credentials()
print(f'认证状态: {result}')
"

# 3. 重新配置密钥
vim .env
# 更新以下变量:
# TWITTER_API_KEY=your_new_api_key
# TWITTER_API_SECRET=your_new_api_secret
# TWITTER_ACCESS_TOKEN=your_new_access_token
# TWITTER_ACCESS_TOKEN_SECRET=your_new_access_token_secret
# TWITTER_BEARER_TOKEN=your_new_bearer_token

# 4. 重启服务
python -m app.cli restart
```

**预防措施**:
- 定期检查API密钥有效性
- 设置密钥过期提醒
- 使用密钥管理工具
- 实施密钥轮换策略

#### API密钥权限不足

**症状**:
- 错误信息: "Forbidden: You don't have permission to access this resource"
- 特定功能无法使用

**解决方案**:
1. 检查Twitter开发者账户权限
2. 确认应用权限设置
3. 申请必要的API访问级别
4. 更新应用权限配置

### 2. 网络和连接问题

#### 网络连接超时

**症状**:
- 错误信息: "Connection timeout"
- API调用失败
- 间歇性连接问题

**诊断步骤**:

```bash
# 1. 检查网络连接
ping api.twitter.com
curl -I https://api.twitter.com/2/tweets

# 2. 检查DNS解析
nslookup api.twitter.com
dig api.twitter.com

# 3. 检查防火墙设置
sudo iptables -L
sudo ufw status

# 4. 测试代理设置
echo $HTTP_PROXY
echo $HTTPS_PROXY
```

**解决方案**:

```bash
# 1. 配置网络超时
vim config/config.yaml
# 增加超时设置:
# network:
#   timeout_seconds: 60
#   retry_attempts: 3
#   backoff_factor: 2

# 2. 配置代理 (如果需要)
export HTTP_PROXY=http://proxy.company.com:8080
export HTTPS_PROXY=http://proxy.company.com:8080

# 3. 调整防火墙规则
sudo ufw allow out 443/tcp
sudo ufw allow out 80/tcp
```

#### SSL/TLS证书问题

**症状**:
- 错误信息: "SSL certificate verify failed"
- HTTPS连接失败

**解决方案**:

```bash
# 1. 更新CA证书
sudo apt update && sudo apt install ca-certificates

# 2. 检查系统时间
date
sudo ntpdate -s time.nist.gov

# 3. 临时禁用SSL验证 (仅用于调试)
export PYTHONHTTPSVERIFY=0
# 或在代码中设置:
# requests.get(url, verify=False)
```

### 3. 数据库问题

#### 数据库连接失败

**症状**:
- 错误信息: "Database connection failed"
- 应用启动失败
- 数据操作异常

**诊断步骤**:

```bash
# 1. 检查数据库文件
ls -la data/twitter_publisher.db

# 2. 检查数据库权限
sudo -u twitter ls -la data/

# 3. 测试数据库连接
python -c "
from app.database.db_manager import DatabaseManager
db = DatabaseManager()
result = db.check_health()
print(f'数据库状态: {result}')
"

# 4. 检查数据库完整性
sqlite3 data/twitter_publisher.db "PRAGMA integrity_check;"
```

**解决方案**:

```bash
# 1. 修复权限问题
sudo chown twitter:twitter data/twitter_publisher.db
sudo chmod 664 data/twitter_publisher.db

# 2. 重新初始化数据库
python -m app.cli db init --force

# 3. 从备份恢复
python -m app.cli db restore --backup-path=backups/latest.db

# 4. 修复数据库
sqlite3 data/twitter_publisher.db ".recover" | sqlite3 data/twitter_publisher_recovered.db
```

#### 数据库锁定问题

**症状**:
- 错误信息: "Database is locked"
- 操作超时
- 并发访问冲突

**解决方案**:

```bash
# 1. 检查数据库锁
lsof data/twitter_publisher.db

# 2. 终止占用进程
sudo kill -9 <pid>

# 3. 清理WAL文件
rm -f data/twitter_publisher.db-wal data/twitter_publisher.db-shm

# 4. 优化数据库设置
sqlite3 data/twitter_publisher.db "
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
PRAGMA cache_size=10000;
PRAGMA temp_store=memory;
"
```

### 4. 内容处理问题

#### 内容生成失败

**症状**:
- Gemini AI调用失败
- 内容格式错误
- 生成内容为空

**诊断步骤**:

```bash
# 1. 检查Gemini API密钥
echo $GEMINI_API_KEY

# 2. 测试API连接
curl -H "Authorization: Bearer $GEMINI_API_KEY" \
     "https://generativelanguage.googleapis.com/v1/models"

# 3. 检查内容源文件
ls -la projects/*/content/
file projects/*/content/*
```

**解决方案**:

```bash
# 1. 验证API密钥
python -c "
from app.services.gemini_service import GeminiService
service = GeminiService()
result = service.test_connection()
print(f'Gemini连接状态: {result}')
"

# 2. 检查内容格式
python -m app.cli content validate --project-id=1

# 3. 重新生成内容
python -m app.cli content generate --project-id=1 --force
```

#### 字符限制问题

**症状**:
- 推文内容过长
- 字符计算错误
- 发布失败

**解决方案**:

```python
# 内容长度检查和截断
def validate_tweet_length(content: str, max_length: int = 280) -> str:
    """验证和调整推文长度"""
    if len(content) <= max_length:
        return content
    
    # 智能截断，保留完整单词
    truncated = content[:max_length-3]
    last_space = truncated.rfind(' ')
    if last_space > max_length * 0.8:  # 如果截断点合理
        truncated = truncated[:last_space]
    
    return truncated + "..."

# 使用示例
content = validate_tweet_length(original_content)
```

### 5. 调度和任务问题

#### 任务调度失败

**症状**:
- 任务不执行
- 调度器停止工作
- 任务状态异常

**诊断步骤**:

```bash
# 1. 检查调度器状态
python -m app.cli scheduler status

# 2. 查看待执行任务
python -m app.cli tasks list --status=pending

# 3. 检查调度器日志
python -m app.cli logs --component=scheduler

# 4. 验证调度配置
python -m app.cli config show --section=scheduling
```

**解决方案**:

```bash
# 1. 重启调度器
python -m app.cli scheduler restart

# 2. 清理异常任务
python -m app.cli tasks cleanup --status=failed

# 3. 手动执行任务
python -m app.cli tasks execute --task-id=123

# 4. 重置调度器状态
python -m app.cli scheduler reset
```

#### 任务执行超时

**症状**:
- 任务长时间运行
- 超时错误
- 资源占用过高

**解决方案**:

```bash
# 1. 调整超时设置
vim config/config.yaml
# scheduling:
#   task_timeout_minutes: 30
#   max_concurrent_tasks: 2

# 2. 终止超时任务
python -m app.cli tasks kill --task-id=123

# 3. 优化任务执行
python -m app.cli tasks optimize
```

### 6. 性能问题

#### 高内存使用

**症状**:
- 内存使用率过高
- 系统响应缓慢
- 内存泄漏

**诊断步骤**:

```bash
# 1. 检查内存使用
free -h
ps aux | grep python | head -10

# 2. 分析内存分布
python -c "
import psutil
import os
process = psutil.Process(os.getpid())
memory_info = process.memory_info()
print(f'RSS: {memory_info.rss / 1024 / 1024:.2f} MB')
print(f'VMS: {memory_info.vms / 1024 / 1024:.2f} MB')
"

# 3. 内存分析工具
pip install memory-profiler
python -m memory_profiler app/main.py
```

**解决方案**:

```bash
# 1. 调整内存限制
vim config/config.yaml
# performance:
#   max_memory_mb: 1024
#   gc_threshold: 0.8

# 2. 启用内存监控
python -m app.cli performance monitor --memory

# 3. 重启服务释放内存
sudo systemctl restart twitter-publisher

# 4. 优化代码
# - 使用生成器代替列表
# - 及时释放大对象
# - 避免循环引用
```

#### 高CPU使用

**症状**:
- CPU使用率持续过高
- 系统负载高
- 响应时间长

**诊断和解决**:

```bash
# 1. 检查CPU使用
top -p $(pgrep -f "python.*app")
htop

# 2. 分析CPU热点
pip install py-spy
py-spy top --pid $(pgrep -f "python.*app")

# 3. 调整并发设置
vim config/config.yaml
# scheduling:
#   max_concurrent_tasks: 1  # 降低并发
#   batch_size: 3           # 减少批处理大小

# 4. 启用CPU限制
sudo systemctl edit twitter-publisher
# [Service]
# CPUQuota=50%
```

### 7. 文件系统问题

#### 磁盘空间不足

**症状**:
- 错误信息: "No space left on device"
- 文件写入失败
- 日志停止记录

**解决方案**:

```bash
# 1. 检查磁盘使用
df -h
du -sh /opt/twitter-publisher/*

# 2. 清理日志文件
find logs/ -name "*.log" -mtime +30 -delete
find logs/ -name "*.log.*" -delete

# 3. 清理临时文件
rm -rf /tmp/twitter-publisher-*
rm -rf data/temp/*

# 4. 压缩旧数据
gzip logs/*.log
tar -czf backups/old_data_$(date +%Y%m%d).tar.gz data/old/

# 5. 配置日志轮转
vim /etc/logrotate.d/twitter-publisher
# /opt/twitter-publisher/logs/*.log {
#     daily
#     missingok
#     rotate 30
#     compress
#     delaycompress
#     notifempty
#     copytruncate
# }
```

#### 文件权限问题

**症状**:
- 权限拒绝错误
- 文件无法读写
- 服务启动失败

**解决方案**:

```bash
# 1. 检查文件权限
ls -la /opt/twitter-publisher/
ls -la /opt/twitter-publisher/data/
ls -la /opt/twitter-publisher/logs/

# 2. 修复权限
sudo chown -R twitter:twitter /opt/twitter-publisher/
sudo chmod -R 755 /opt/twitter-publisher/
sudo chmod -R 664 /opt/twitter-publisher/data/
sudo chmod -R 664 /opt/twitter-publisher/logs/
sudo chmod +x /opt/twitter-publisher/scripts/*.sh

# 3. 设置SELinux上下文 (如果启用)
sudo setsebool -P httpd_can_network_connect 1
sudo semanage fcontext -a -t httpd_exec_t "/opt/twitter-publisher/app(/.*)?"
sudo restorecon -R /opt/twitter-publisher/
```

## 高级故障排除

### 1. 调试模式

```bash
# 启用调试模式
export APP_DEBUG=true
export LOG_LEVEL=DEBUG

# 启动调试服务
python -m app.main --debug

# 使用调试器
python -m pdb app/main.py

# 远程调试
pip install debugpy
python -m debugpy --listen 0.0.0.0:5678 --wait-for-client -m app.main
```

### 2. 性能分析

```bash
# CPU性能分析
pip install cProfile
python -m cProfile -o profile.stats app/main.py
python -c "import pstats; p = pstats.Stats('profile.stats'); p.sort_stats('cumulative'); p.print_stats(20)"

# 内存分析
pip install tracemalloc
python -c "
import tracemalloc
tracemalloc.start()
# 运行代码
current, peak = tracemalloc.get_traced_memory()
print(f'Current: {current / 1024 / 1024:.2f} MB')
print(f'Peak: {peak / 1024 / 1024:.2f} MB')
"

# 网络分析
sudo tcpdump -i any -w network.pcap host api.twitter.com
wireshark network.pcap
```

### 3. 系统监控

```bash
# 实时系统监控
watch -n 1 'ps aux | grep python; free -h; df -h'

# 网络连接监控
watch -n 5 'netstat -tuln | grep :8080'

# 文件描述符监控
watch -n 5 'lsof -p $(pgrep -f "python.*app") | wc -l'

# 系统调用跟踪
sudo strace -p $(pgrep -f "python.*app") -e trace=network
```

## 故障预防

### 1. 监控告警

```yaml
# 配置告警规则
monitoring:
  alerts:
    high_memory:
      threshold: 80%
      duration: 5m
      action: restart
    
    high_error_rate:
      threshold: 5%
      duration: 2m
      action: notify
    
    disk_space:
      threshold: 90%
      duration: 1m
      action: cleanup
```

### 2. 健康检查

```python
# 自动健康检查脚本
#!/usr/bin/env python3
import subprocess
import sys
import time

def health_check():
    """执行健康检查"""
    try:
        result = subprocess.run(
            ['python', '-m', 'app.cli', 'health'],
            capture_output=True,
            text=True,
            timeout=30
        )
        
        if result.returncode == 0:
            print("✅ 系统健康")
            return True
        else:
            print(f"❌ 健康检查失败: {result.stderr}")
            return False
            
    except subprocess.TimeoutExpired:
        print("❌ 健康检查超时")
        return False
    except Exception as e:
        print(f"❌ 健康检查异常: {e}")
        return False

if __name__ == "__main__":
    if not health_check():
        sys.exit(1)
```

### 3. 自动恢复

```bash
# 自动恢复脚本
#!/bin/bash

SERVICE_NAME="twitter-publisher"
MAX_RETRIES=3
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if systemctl is-active --quiet $SERVICE_NAME; then
        echo "服务正常运行"
        exit 0
    fi
    
    echo "服务异常，尝试重启... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
    systemctl restart $SERVICE_NAME
    sleep 30
    
    RETRY_COUNT=$((RETRY_COUNT + 1))
done

echo "服务恢复失败，需要人工干预"
exit 1
```

## 紧急响应流程

### 1. 服务完全不可用

```bash
# 紧急恢复步骤
# 1. 检查服务状态
sudo systemctl status twitter-publisher

# 2. 查看最新错误
sudo journalctl -u twitter-publisher --since "5 minutes ago"

# 3. 尝试重启服务
sudo systemctl restart twitter-publisher

# 4. 如果重启失败，从备份恢复
sudo systemctl stop twitter-publisher
cp /opt/backups/latest/twitter_publisher.db /opt/twitter-publisher/data/
sudo systemctl start twitter-publisher

# 5. 如果仍然失败，启用维护模式
echo "系统维护中，请稍后再试" > /opt/twitter-publisher/maintenance.html
nginx -s reload
```

### 2. 数据丢失

```bash
# 数据恢复步骤
# 1. 停止所有写操作
sudo systemctl stop twitter-publisher

# 2. 评估数据损失
sqlite3 data/twitter_publisher.db "PRAGMA integrity_check;"

# 3. 从最近备份恢复
cp /opt/backups/$(ls -t /opt/backups/ | head -1)/twitter_publisher.db data/

# 4. 验证数据完整性
python -m app.cli db validate

# 5. 重启服务
sudo systemctl start twitter-publisher
```

### 3. 安全事件

```bash
# 安全响应步骤
# 1. 立即断开网络连接
sudo iptables -A INPUT -j DROP
sudo iptables -A OUTPUT -j DROP

# 2. 保存系统状态
ps aux > /tmp/processes.txt
netstat -tuln > /tmp/network.txt
lsof > /tmp/files.txt

# 3. 检查异常活动
sudo grep -i "failed\|error\|unauthorized" /var/log/auth.log
sudo grep -i "attack\|intrusion" /opt/twitter-publisher/logs/app.log

# 4. 更换所有密钥
# - 生成新的API密钥
# - 更新数据库密码
# - 重新生成JWT密钥

# 5. 恢复网络连接
sudo iptables -F
```

## 联系支持

### 收集诊断信息

```bash
# 生成诊断报告
python -m app.cli diagnostic --output=diagnostic_report.zip

# 手动收集信息
echo "=== 系统信息 ===" > diagnostic.txt
uname -a >> diagnostic.txt
echo "\n=== 服务状态 ===" >> diagnostic.txt
sudo systemctl status twitter-publisher >> diagnostic.txt
echo "\n=== 最新日志 ===" >> diagnostic.txt
tail -100 logs/app.log >> diagnostic.txt
echo "\n=== 配置信息 ===" >> diagnostic.txt
python -m app.cli config show --sanitized >> diagnostic.txt
```

### 支持渠道

1. **GitHub Issues**: 报告bug和功能请求
2. **文档**: 查看在线文档和FAQ
3. **社区论坛**: 与其他用户交流
4. **企业支持**: 付费技术支持服务

---

**下一步**: 查看 [重构总结](08_重构总结.md) 了解项目的重构历史和改进。